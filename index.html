<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>ç»¼åˆæµ‹è¯„ä¸å¥–å­¦é‡‘ç®¡ç†ç³»ç»Ÿ</title>
  
  <!-- å…¨å±€é”™è¯¯æ•æ‰å™¨ï¼šé˜²æ­¢æ— æç¤ºç™½å± -->
  <script>
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('Script error')) return; // å¿½ç•¥æ— ç”¨çš„è·¨åŸŸè­¦å‘Š
      document.body.innerHTML += '<div style="position:fixed;top:0;left:0;width:100%;background:#fee2e2;color:#991b1b;padding:20px;z-index:99999;font-family:sans-serif;border-bottom:2px solid #f87171;"><b>ç³»ç»ŸåŠ è½½å¼‚å¸¸ï¼š</b>' + e.message + '<br><small>æ’æŸ¥å»ºè®®ï¼šè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦ç¨³å®šï¼Œæˆ– Firebase é…ç½®æ˜¯å¦æ­£ç¡®ã€‚</small></div>';
    });
  </script>

  <!-- æ ¸å¿ƒä¾èµ–åº“ (å…¨éƒ¨é‡‡ç”¨å›½å†…æé€Ÿæˆ–é«˜å¯ç”¨ CDN) -->
  <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)" crossorigin="anonymous"></script>
  <script src="[https://cdn.staticfile.net/babel-standalone/7.23.6/babel.min.js](https://cdn.staticfile.net/babel-standalone/7.23.6/babel.min.js)" crossorigin="anonymous"></script>

  <!-- ES Modules æ˜ å°„è¡¨ (å¢åŠ ä¾èµ–é”å®šï¼Œé˜²æ­¢åŠ è½½ç™½å±) -->
  <script type="importmap">
  {
    "imports": {
      "react": "[https://esm.sh/react@18.2.0](https://esm.sh/react@18.2.0)",
      "react-dom/client": "[https://esm.sh/react-dom@18.2.0/client](https://esm.sh/react-dom@18.2.0/client)",
      "lucide-react": "[https://esm.sh/lucide-react@0.263.1?external=react](https://esm.sh/lucide-react@0.263.1?external=react)",
      "firebase/app": "[https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js](https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js)",
      "firebase/auth": "[https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js](https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js)",
      "firebase/firestore": "[https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js](https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js)",
      "xlsx": "[https://esm.sh/xlsx@0.18.5](https://esm.sh/xlsx@0.18.5)"
    }
  }
  </script>
  <style>
    @keyframes slow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-slow-spin { animation: slow-spin 10s linear infinite; }
    @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .animate-bounce-slow { animation: bounce-slow 3s ease-in-out infinite; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans selection:bg-indigo-100">
  <div id="root"></div>

  <!-- æ˜ç¡®æŒ‡å®š presets="react" ä¿è¯ Babel æ­£ç¡®ç¼–è¯‘ JSX è€Œä¸ç ´å Import -->
  <script type="text/babel" data-type="module" data-presets="react">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Trophy, Users, BookOpen, PlusCircle, Trash2, Save, 
      UploadCloud, AlertCircle, CheckCircle, Clock, Edit3, 
      Sparkles, FileDown, Eye, FileText, AlertTriangle, LogOut, Loader2, ShieldCheck, ListOrdered, KeyRound, Fingerprint, PlayCircle, Settings, ChevronRight, Search
    } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, query, getDoc } from 'firebase/firestore';
    import * as XLSX from 'xlsx';

    // ==========================================
    // ğŸš€ æ•°æ®åº“é…ç½®åŒº
    // ==========================================
    const localFirebaseConfig = {
      apiKey: "åœ¨æ­¤å¡«å…¥ä½ çš„ apiKey",
      authDomain: "åœ¨æ­¤å¡«å…¥ä½ çš„ authDomain",
      projectId: "åœ¨æ­¤å¡«å…¥ä½ çš„ projectId",
      storageBucket: "åœ¨æ­¤å¡«å…¥ä½ çš„ storageBucket",
      messagingSenderId: "åœ¨æ­¤å¡«å…¥ä½ çš„ messagingSenderId",
      appId: "åœ¨æ­¤å¡«å…¥ä½ çš„ appId"
    };

    let envConfig = null;
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
      try {
        envConfig = JSON.parse(__firebase_config);
      } catch (e) {
        console.error("Firebase é…ç½®è§£æå¼‚å¸¸:", e);
      }
    }
    
    const finalConfig = envConfig || localFirebaseConfig;
    const isConfigValid = finalConfig && finalConfig.apiKey && !finalConfig.apiKey.includes("åœ¨æ­¤å¡«å…¥");

    let app, auth, db;
    if (isConfigValid) {
      try {
        app = initializeApp(finalConfig);
        auth = getAuth(app);
        db = getFirestore(app);
      } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", e);
      }
    }
    
    const globalAppId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'zongce-pro-system';
    
    // ==========================================
    // ğŸ¤– AI å¼•æ“é…ç½®ä¸å¯†é’¥
    // ==========================================
    const aiApiKey = "sk-gjzyakonhvumcdbirrvpghlyplwyxbxqthsqefoaqonljkmw";

    const fetchWithRetry = async (url, options, retries = 3) => {
      const delays = [1000, 2000, 4000];
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP çŠ¶æ€ç å¼‚å¸¸: ${response.status}`);
          return await response.json();
        } catch (err) {
          if (i === retries - 1) throw err;
          await new Promise(res => setTimeout(res, delays[i]));
        }
      }
    };

    // ==========================================
    // âš™ï¸ æ‹¦æˆªå¼•å¯¼ç•Œé¢ (å®Œå…¨ç‹¬ç«‹ï¼Œé˜²æ­¢æ±¡æŸ“ React Hooks æ¸²æŸ“æ ‘)
    // ==========================================
    const ConfigErrorUI = () => (
      <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900 font-sans">
        <div className="max-w-xl w-full bg-white rounded-3xl p-10 shadow-2xl border border-white/20">
          <div className="flex justify-center mb-8">
            <div className="p-6 bg-amber-50 rounded-full border-4 border-amber-100">
              <Settings className="w-16 h-16 text-amber-600 animate-slow-spin" />
            </div>
          </div>
          <h2 className="text-3xl font-black text-center mb-4 text-slate-800">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…é…ç½®</h2>
          <p className="text-slate-500 text-center text-sm mb-10 leading-relaxed">æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ç›´æ¥æ‰“å¼€åº”ç”¨ã€‚ä¸ºäº†å¯ç”¨äº‘ç«¯å­˜å‚¨å’Œ AI å®¡æ ¸ï¼Œè¯·é…ç½®æ‚¨è‡ªå·±çš„ Firebase å‚æ•°ã€‚</p>
          <div className="space-y-4">
            <div className="flex gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-200">
              <div className="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
              <p className="text-sm text-slate-600">è®¿é—® <b>firebase.google.com</b> åˆ›å»ºå…è´¹é¡¹ç›®ï¼Œå¹¶å¼€å¯ Firestore æ•°æ®åº“ä¸åŒ¿åç™»å½• (Anonymous Auth)ã€‚</p>
            </div>
            <div className="flex gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-200">
              <div className="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
              <p className="text-sm text-slate-600">è·å– Web SDK é…ç½®ï¼Œå¹¶æ›¿æ¢ <b>index.html</b> ä¸­ç¬¬ <b>59è¡Œ</b> é™„è¿‘çš„ <b>localFirebaseConfig</b> å­—å…¸å†…å®¹ã€‚</p>
            </div>
          </div>
        </div>
      </div>
    );

    // ==========================================
    // ğŸ† ç³»ç»Ÿä¸»æ§ä¸­å¿ƒ
    // ==========================================
    const App = () => {
      // --- å…¨å±€çŠ¶æ€å®šä¹‰ ---
      const [user, setUser] = useState(null);
      const [isDbReady, setIsDbReady] = useState(false);
      const [dbError, setDbError] = useState('');
      const [classesData, setClassesData] = useState({});
      const [studentsData, setStudentsData] = useState([]);
      const [currentClass, setCurrentClass] = useState(null);
      const [currentUser, setCurrentUser] = useState(''); 
      const [currentStudentId, setCurrentStudentId] = useState(''); 
      const [currentUserRole, setCurrentUserRole] = useState(''); 
      const [viewState, setViewState] = useState('lobby'); 
      const [activeTab, setActiveTab] = useState('ranking'); 
      const [newClassNameInput, setNewClassNameInput] = useState('');
      const [newClassAdminPwdInput, setNewClassAdminPwdInput] = useState('');
      const [newClassRoster, setNewClassRoster] = useState([]);
      const [isAiParsingRoster, setIsAiParsingRoster] = useState(false); 
      const [selectedClassToJoin, setSelectedClassToJoin] = useState('');
      const [loginRoleTab, setLoginRoleTab] = useState('student'); 
      const [userNameInput, setUserNameInput] = useState('');
      const [studentIdInput, setStudentIdInput] = useState('');
      const [adminPwdInput, setAdminPwdInput] = useState('');
      const [formName, setFormName] = useState('');
      const [formOriginalGrade, setFormOriginalGrade] = useState('');
      const [formBonusItems, setFormBonusItems] = useState([]);
      const [isReadOnly, setIsReadOnly] = useState(false); 
      const [aiRulesText, setAiRulesText] = useState('');
      const [pdfFile, setPdfFile] = useState({ name: '', base64: '', mimeType: '' });
      const [isAiReviewing, setIsAiReviewing] = useState(false);
      const [isBatching, setIsBatching] = useState(false);
      const [batchProgress, setBatchProgress] = useState('');
      const fileInputRef = useRef(null);
      const [previewImage, setPreviewImage] = useState(null); 
      const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
      const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null });

      // --- æ ¸å¿ƒåŒæ­¥é€»è¾‘ ---
      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) { 
            console.error("é‰´æƒæ‹¦æˆª:", error);
            setDbError('äº‘ç«¯èŠ‚ç‚¹éªŒè¯è¢«æ‹’ç»ï¼Œè¯·ç¡®è®¤ Firebase åå°å·²å¼€å¯ åŒ¿åç™»å½•æä¾›æ–¹(Anonymous Auth)ã€‚'); 
          }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user || !db) return;
        const classesRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'classes');
        const unsubClasses = onSnapshot(classesRef, (snapshot) => {
          const newClasses = {};
          snapshot.forEach(doc => { newClasses[doc.id] = doc.data(); });
          setClassesData(newClasses);
          setDbError('');
        }, (err) => {
          console.error("æ•°æ®åº“å¿«ç…§å¼‚å¸¸:", err);
          setDbError('æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼šè¯·æ£€æŸ¥ Firestore è§„åˆ™(Rules)æ˜¯å¦è®¾ç½®ä¸ºå…è®¸è¯»å†™è®¿é—®ã€‚');
        });
        
        const studentsRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'students');
        const unsubStudents = onSnapshot(studentsRef, (snapshot) => {
          const newStudents = [];
          snapshot.forEach(doc => { newStudents.push({ id: doc.id, ...doc.data() }); });
          setStudentsData(newStudents);
          setIsDbReady(true);
        });
        return () => { unsubClasses(); unsubStudents(); };
      }, [user]);

      // --- ä¸šåŠ¡å·¥å…·é€»è¾‘ ---
      const showToast = (message, type = 'success') => {
        setToast({ show: true, message, type });
        setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3500);
      };

      const compressImage = (file, callback) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 1200;
            let width = img.width; let height = img.height;
            if (width > MAX_WIDTH) { height = Math.round((height * MAX_WIDTH) / width); width = MAX_WIDTH; }
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.65));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      };

      const currentStudents = useMemo(() => studentsData.filter(s => s.className === currentClass), [currentClass, studentsData]);
      
      const rankedStudents = useMemo(() => {
        if (currentStudents.length === 0) return [];
        const withRaw = currentStudents.map(s => ({
          ...s, rawBonus: s.bonusItems?.reduce((sum, item) => sum + (parseFloat(item.points) || 0), 0) || 0
        }));
        const maxRaw = Math.max(...withRaw.map(s => s.rawBonus), 0);
        return withRaw.map(s => {
          const scaled = maxRaw > 0 ? (s.rawBonus / maxRaw) * 3 : 0;
          return {
            ...s, scaledBonus: scaled.toFixed(4),
            totalScore: (parseFloat(s.originalGrade || 0) + scaled).toFixed(2),
            hasAiWarning: s.bonusItems?.some(i => i.aiStatus === 'Reject' || i.aiStatus === 'Manual Review' || !i.aiStatus || i.aiStatus === 'Pending')
          };
        }).sort((a, b) => b.totalScore - a.totalScore);
      }, [currentStudents]);

      // --- å¤šæ¨¡æ€ AI è§£æåå•å¼•æ“ ---
      const handleRosterUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        setIsAiParsingRoster(true); showToast("æ­£åœ¨è¿æ¥è§†è§‰å¤§æ¨¡å‹ï¼Œè¯·è€å¿ƒç­‰å¾… AI ç»“æ„åŒ–æ•°æ®...", 'success');
        try {
          let textPayload = [];
          if (file.type.startsWith('image/')) {
            const b64 = await new Promise(r => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(file); });
            textPayload = [{ type: "text", text: "æå–å›¾ç‰‡ä¸­çš„æ‰€æœ‰å­¦ç”Ÿå§“åå’Œå­¦å·å¯¹ã€‚å¿…é¡»ä¸”ä»…è¾“å‡ºåˆæ³•çš„ JSON æ•°ç»„ï¼Œå½¢å¦‚ [{\"name\":\"å¼ ä¸‰\",\"studentId\":\"2023001\"}]ã€‚ç»å¯¹ç¦æ­¢è¾“å‡ºä»»ä½•å¤šä½™çš„è§£é‡Šæ–‡å­—ï¼" }, { type: "image_url", image_url: { url: b64 } }];
          } else {
            const buffer = await file.arrayBuffer();
            const wb = XLSX.read(buffer);
            const csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]);
            // å‰¥ç¦»å¤æ‚æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„å¹²æ‰°ç¬¦å·ï¼Œæ”¹ä¸ºå®‰å…¨åŠ å·æ‹¼æ¥
            const safePrompt = "åˆ†æä»¥ä¸‹è¡¨æ ¼æ•°æ®ï¼Œæå–æ‰€æœ‰çš„å§“åå’Œå­¦å·å¯¹ã€‚\nå¿…é¡»ä¸”ä»…è¾“å‡ºåˆæ³•çš„ JSON æ•°ç»„æ ¼å¼ï¼Œç»å¯¹ç¦æ­¢åœ¨å¼€å¤´æˆ–ç»“å°¾åŒ…å«ç±»ä¼¼ markdown çš„ä»£ç å—ç¬¦å·ç­‰ä»»ä½•è¯´æ˜æ–‡æœ¬ï¼š\n" + csv.substring(0, 10000);
            textPayload = [{ type: "text", text: safePrompt }];
          }
          const res = await fetchWithRetry(`https://api.siliconflow.cn/v1/chat/completions`, {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiApiKey}` },
            body: JSON.stringify({ model: "THUDM/GLM-4.1V-9B-Thinking", messages: [{ role: "user", content: textPayload }] })
          });
          
          let rawContent = res.choices?.[0]?.message?.content || "";
          
          // å¼ºæ•ˆæ­£åˆ™å‰”é™¤ï¼šå½»åº•åˆ‡é™¤ Thinking æ¨¡å‹å‘æ•£çš„æ€è·¯ä¸å¤šä½™ç¬¦å·
          let cleanContent = rawContent.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
          const jsonArrayMatch = cleanContent.match(/\[[\s\S]*\]/);
          
          let list = [];
          if (jsonArrayMatch) {
            list = JSON.parse(jsonArrayMatch[0]);
          } else {
            cleanContent = cleanContent.replace(/```json/gi, '').replace(/```/g, '').trim();
            const parsed = JSON.parse(cleanContent);
            list = Array.isArray(parsed) ? parsed : (parsed.students || parsed.data || []);
          }

          if (list.length === 0) throw new Error("åŒ¹é…å¤±è´¥ï¼šæœªå‘ç°ä»»ä½•æœ‰æ•ˆçš„äººå‘˜çŸ©é˜µæ•°æ®");

          setNewClassRoster(list);
          showToast(`è§†è§‰è§£ææˆåŠŸï¼å·²æ„å»ºåŒ…å« ${list.length} åå­¦ç”Ÿçš„èº«ä»½æŒ‡çº¹åº“ã€‚`, 'success');
        } catch (error) { 
          console.error("AIè§£æå¼‚å¸¸æˆªæ–­:", error);
          showToast(`å¯¼å…¥é‡é˜»ï¼šæ— æ³•è¯†åˆ«è¡¨æ ¼æˆ–å›¾ç‰‡ç»“æ„ï¼ˆç¡®ä¿ç”»è´¨æ¸…æ™°ä¸”åŒ…å«å§“åå­¦å·ï¼‰ï¼Œè¯·é‡è¯•`, 'error'); 
        }
        finally { setIsAiParsingRoster(false); e.target.value = ''; }
      };

      const handleCreateClass = async () => {
        const cName = newClassNameInput.trim();
        if (!cName || classesData[cName]) return showToast("é¡¹ç›®åç§°ä¸ºç©ºæˆ–äº§ç”Ÿåç§°å†²çª", 'error');
        if (!newClassAdminPwdInput.trim()) return showToast("è¶…çº§å®¡è®¡å¯†ç ä¸ºå¿…å¡«é¡¹", 'error');
        if (newClassRoster.length === 0) return showToast("ç³»ç»Ÿå®‰å…¨é”ï¼šå¼ºåˆ¶è¦æ±‚å¿…é¡»åœ¨å¯¼å…¥èŠ±åå†Œåæ‰èƒ½å¼€æ”¾åˆ›å»ºï¼", 'error');

        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', cName), {
            rulesText: "æš‚æ— é™„åŠ æ¨æ¼”è§„åˆ™", rulesPdfBase64: "", rulesPdfName: "", rulesFileMimeType: "application/pdf", 
            adminPwd: newClassAdminPwdInput.trim(), roster: newClassRoster
          });
          setNewClassNameInput(''); setNewClassAdminPwdInput(''); setNewClassRoster([]);
          showToast("è¯„å®šç­çº§èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ", 'success');
        } catch { showToast("æ¡æ‰‹å¤±è´¥ï¼šæ•°æ®åŒæ­¥è‡³äº‘ç«¯å—é˜»", 'error'); }
      };

      const initiateJoinClass = (cName) => {
        setSelectedClassToJoin(cName);
        setUserNameInput(''); setStudentIdInput(''); setAdminPwdInput('');
        setLoginRoleTab('student'); setViewState('login');
      };

      const handleLogin = () => {
        const classData = classesData[selectedClassToJoin];
        if (!classData) return showToast("è·å–äº‘ç«¯èŠ‚ç‚¹æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸", 'error');

        if (loginRoleTab === 'student') {
          if (!userNameInput.trim() || !studentIdInput.trim()) return showToast("èº«ä»½æ¯”å¯¹å‚æ•°ä¸å…è®¸ä¸ºç©º", 'error');
          
          // æåº¦ä¸¥è°¨çš„ç±»å‹è½¬æ¢åŒ¹é…ï¼Œé˜²æ­¢æ•°å­—ä¸å­—ç¬¦ä¸²ä¸ä¸€è‡´å¯¼è‡´è¢«æ‹’
          const isMatch = (classData.roster || []).find(r => 
              String(r.name).trim() === userNameInput.trim() && 
              String(r.studentId).trim() === studentIdInput.trim()
          );

          if (!isMatch) return showToast("é˜²å†’åæ‹¦æˆªï¼šæ‚¨çš„ä¿¡æ¯æœªè¢«æ”¶å½•åœ¨æœ¬ç­çš„åŸå§‹èŠ±åå†Œä¸­ï¼", 'error');
          
          setCurrentUser(userNameInput.trim()); setCurrentStudentId(studentIdInput.trim()); setCurrentUserRole('student');
        } else {
          if (adminPwdInput.trim() !== classData.adminPwd) return showToast("æœ€é«˜æŒ‡ä»¤é”™è¯¯ï¼Œæ‹’ç»è®¿é—®", 'error');
          setCurrentUser('æ ¸å¿ƒå®¡æ ¸å‘˜'); setCurrentStudentId('ADMIN_ROOT'); setCurrentUserRole('admin');
        }
        
        setAiRulesText(classData.rulesText || ''); 
        setPdfFile({ name: classData.rulesPdfName || '', base64: classData.rulesPdfBase64 || '', mimeType: classData.rulesFileMimeType || 'application/pdf' });
        setViewState('dashboard');
      };

      const handleLeaveClass = () => {
        setCurrentClass(null); setCurrentUser(''); setCurrentStudentId(''); setCurrentUserRole('');
        setViewState('lobby');
      };

      const handleDeleteClassByAdmin = () => {
        setConfirmDialog({
          show: true, message: "âš ï¸ ä¸¥é‡çº§è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ‰§è¡Œå½»åº•çš„æ•°æ®æ¸…æ´—ï¼Œæ¸…é™¤è¯¥ç­çº§æ¶æ„åŠå…¶åŒ…å«çš„æ‰€æœ‰å­¦ç”Ÿç”³æŠ¥è®°å½•æ¡£æ¡ˆã€‚æ•°æ®é”€æ¯åæ°¸ä¹…æ— æ³•æ‰¾å›ï¼Œç¡®è®¤è¦æ‰§è¡Œé™ç»´æ‰“å‡»å—ï¼Ÿ",
          onConfirm: async () => {
            try {
              const studentsToDelete = studentsData.filter(s => s.className === currentClass);
              for (const s of studentsToDelete) await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', s.id));
              await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', currentClass));
              handleLeaveClass(); setConfirmDialog({ show: false, message: '', onConfirm: null });
              showToast("ç‰©ç†é”€æ¯å®Œæ¯•ï¼Œç­çº§èŠ‚ç‚¹å·²æ‹”é™¤", 'success');
            } catch (error) { showToast("æ“¦é™¤æŒ‡ä»¤å—é™", 'error'); }
          }
        });
      };

      const handleSaveStudent = async () => {
        if (!formOriginalGrade) return showToast("åŸºå‡†å‚ç…§æˆç»©ä¸å¯ç•™ç©º", 'error');
        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', `${currentClass}_${currentStudentId}`), {
            className: currentClass, name: currentUser, studentId: currentStudentId,
            originalGrade: formOriginalGrade, bonusItems: formBonusItems, lastModified: new Date().toLocaleString()
          });
          showToast("ç§æœ‰å·å®—ä¿å­˜æˆåŠŸï¼Œå·²æ±‡å…¥ä¸­å¤®é˜Ÿåˆ—ç­‰å¾… AI ç»Ÿä¸€æŸ¥éªŒ", 'success'); setActiveTab('ranking');
        } catch { showToast("äº‘ç«¯æµæ§å¼‚å¸¸ï¼Œå†™å…¥å—é˜»", 'error'); }
      };

      // æ ¸å¿ƒæ¨æ¼”å¼•æ“
      const processAI = async (items, studentName) => {
        const updated = [...items];
        const rules = classesData[currentClass]?.rulesText || '';
        const pdf = classesData[currentClass]?.rulesPdfBase64 || '';
        const mime = classesData[currentClass]?.rulesFileMimeType || 'application/pdf';
        
        for (let i = 0; i < updated.length; i++) {
          const it = updated[i];
          if (it.aiStatus !== 'Pending' && it.aiStatus) continue;
          if (!it.points || !it.description) continue;

          // çº¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡ Babel ç¼–è¯‘å™¨å¯èƒ½çš„åµŒå¥—è½¬ä¹‰å¹²æ‰°
          const prompt = "ä½ æ˜¯ä¸€ä¸ªé“é¢æ— ç§çš„ç»¼æµ‹å®¡æ ¸AIã€‚\n" +
            "ã€å—å®¡äººã€‘: " + studentName + "\n" +
            "ã€è¯„å®šæ³•åˆ™ã€‘: " + rules + "\n" +
            "ã€åŠ åˆ†æ˜ç»†ã€‘: ç”³æŠ¥åŠ åˆ† " + it.points + " åˆ†; å½’å±åˆ†ç±»: " + it.type + "; æè¿°äº‹å®: " + it.description + "\n" +
            "ã€ä½è¯ææ–™ã€‘: " + (it.materialName ? "å·²é™„è¯æ˜å›¾ç‰‡(åŠ¡å¿…äº¤å‰æ¯”å¯¹å›¾ç‰‡å†…å®¹ä¸æè¿°å†…å®¹çš„ä¸€è‡´æ€§)" : "æŸ¥æ— å‡­è¯") + "\n\n" +
            "ã€åˆ¤å†³é“å¾‹ã€‘:\n" +
            "1. é˜²ç‰¹æƒæ»¥ç”¨ï¼šå¦‚æœæ³•åˆ™èµ‹äºˆç‰¹å®šäººç‰¹æƒï¼ˆä¾‹å¦‚å…è®¸å¼ ä¸‰å…äº¤ææ–™ï¼‰ï¼Œä½ å¿…é¡»æ ¸å¯¹ä¸Šæ–¹çš„ã€å—å®¡äººã€‘åå­—ã€‚å¦‚æœæ˜¯å…¶ä»–äººå¼ºè¡Œå¥—ç”¨ï¼Œå¿…å®šä¸¥è¯é©³å›ï¼\n" +
            "2. è¯æ®é—­ç¯åŸåˆ™ï¼šè‹¥æ²¡æœ‰ä»»ä½•é™„ä»¶ææ–™ï¼Œä¸”æŸ¥æ— æ³•åˆ™çš„ç‰¹ä¾‹è±å…ï¼Œä¸€å¾‹ç»™å‡ºé©³å›(Reject)æˆ–è½¬äººå·¥(Manual Review)è£å®šã€‚\n" +
            "3. ç»å¯¹è¾“å‡ºæŒ‡ä»¤ï¼šä½ çš„å›ç­”å¿…é¡»å¹¶ä¸”åªèƒ½æ˜¯ä¸€ä¸ªåˆæ³•çš„ JSON å¯¹è±¡ï¼Œä¸åŒ…å«ä»»ä½•å¤–éƒ¨ Markdown è®°å·ï¼š\n" +
            "{\"status\": \"Approve\"|\"Reject\"|\"Manual Review\", \"reason\": \"åœ¨æ­¤å¡«å†™15å­—ä»¥å†…çš„ä¸­æ–‡è£å†³åŸå› \"}";

          try {
            const content = [{ type: "text", text: prompt }];
            if (pdf) content.push({ type: "image_url", image_url: { url: `data:${mime};base64,${pdf}` } });
            if (it.materialBase64) content.push({ type: "image_url", image_url: { url: it.materialBase64 } });
            
            const res = await fetchWithRetry(`https://api.siliconflow.cn/v1/chat/completions`, {
              method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiApiKey}` },
              body: JSON.stringify({ model: "THUDM/GLM-4.1V-9B-Thinking", messages: [{ role: "user", content }] })
            });
            
            let rawResult = res.choices?.[0]?.message?.content || '{"status": "Manual Review", "reason": "APIæ•°æ®å±‚å¹²æ¶¸"}';
            let cleanResult = rawResult.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
            const jsonObjMatch = cleanResult.match(/\{[\s\S]*\}/);
            let decision;
            if (jsonObjMatch) {
                decision = JSON.parse(jsonObjMatch[0]);
            } else {
                decision = JSON.parse(cleanResult.replace(/```json/gi, '').replace(/```/g, '').trim());
            }
            updated[i].aiStatus = decision.status; updated[i].aiReason = decision.reason;
          } catch (e) { 
            console.error("AI è§†è§‰æ¨æ¼”å•é¡¹ç†”æ–­:", e);
            updated[i].aiStatus = 'Manual Review'; updated[i].aiReason = 'ä¸Šæ¸¸è§†è§‰æ¨¡å‹é™æµæˆ–è¯·æ±‚æ®‹ç¼º'; 
          }
        }
        return updated;
      };

      const handleBatchAudit = async () => {
        const targets = currentStudents.filter(s => s.bonusItems?.some(i => i.aiStatus === 'Pending' || !i.aiStatus));
        if (!targets.length) return showToast("æ‰«æå®Œæ¯•ï¼šå½“å‰æ± ä¸­æ— ä»»ä½•å¾…åŠåˆ¤å®šè¯·æ±‚", 'success');
        
        setIsBatching(true);
        for (let i = 0; i < targets.length; i++) {
          const s = targets[i]; 
          setBatchProgress(`AI æ­£åœ¨é«˜ç»´æ¨æ¼”ç›®æ ‡: ${s.name} (${i+1}/${targets.length})`);
          const items = await processAI(s.bonusItems, s.name);
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', `${currentClass}_${s.studentId}`), { ...s, bonusItems: items });
          // é˜²å¹³å° API é™æµï¼šæµæ°´çº¿é—´éš”å¼ºåˆ¶ä¼‘çœ é™é¢‘ 2.5 ç§’
          if (i < targets.length - 1) await new Promise(r => setTimeout(r, 2500));
        }
        setIsBatching(false); showToast("å…¨ç­æµæ°´çº¿æ·±åº¦æ ¸éªŒä»»åŠ¡å·²åœ†æ»¡ç«£å·¥", 'success');
      };

      // --- ä¸“ä¸šè¡¨æ ¼å¯¼å‡º ---
      const exportTable = () => {
        if (!rankedStudents.length) return showToast("çŸ©é˜µæ± ç©ºç¼ºï¼Œæ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®", 'error');
        const aoa = [[`${currentClass}ç­ç»¼åˆç´ è´¨æµ‹è¯„æ˜ç»†è¡¨`], [], ["æ’å", "å§“å", "å­¦å·", "åŸºç¡€æˆç»©", "æ´»åŠ¨æè¿°", "ç”³æŠ¥å•é¡¹", "ç”³æŠ¥æ€»è®¡", "è§„åˆ™æŠ˜åˆåˆ†", "AIç»ˆå®¡å®šè°ƒ"]];
        rankedStudents.forEach((s, idx) => {
          const items = s.bonusItems?.length ? s.bonusItems : [{ description: 'æ— åŠ åˆ†è®°å½•', points: 0, aiStatus: 'N/A' }];
          items.forEach((it, i) => {
            aoa.push([ i===0?idx+1:'', i===0?s.name:'', i===0?s.studentId:'', i===0?s.originalGrade:'', it.description, it.points, i===0?s.rawBonus:'', i===0?s.scaledBonus:'', it.aiStatus ]);
          });
        });
        const ws = XLSX.utils.aoa_to_sheet(aoa); ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æ•°æ®æ¸…å•");
        XLSX.writeFile(wb, `${currentClass}_ä¸“ä¸šç»¼æµ‹ç»Ÿè®¡æ¡£æ¡ˆ.xlsx`);
      };

      // --- è¡¨å•æŸ¥çœ‹ä¸è§„åˆ™ä¿å­˜ ---
      const initMyApplication = () => {
        const me = currentStudents.find(s => s.studentId === currentStudentId);
        setIsReadOnly(false); setFormName(currentUser);
        if (me) { setFormOriginalGrade(me.originalGrade); setFormBonusItems(me.bonusItems || []); } 
        else { setFormOriginalGrade(''); setFormBonusItems([]); }
        setActiveTab('application');
      };

      const loadStudentFormReadOnly = (student) => {
        if (student.studentId === currentStudentId) return initMyApplication();
        setFormName(student.name); setFormOriginalGrade(student.originalGrade); setFormBonusItems(student.bonusItems || []);
        setIsReadOnly(true); setActiveTab('application');
      };

      const updateBonusItem = (id, field, value) => {
        setFormBonusItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value, aiStatus: 'Pending', aiReason: '' } : item));
      };
      const removeBonusItem = (id) => { setFormBonusItems(prev => prev.filter(item => item.id !== id)); };

      const handleRuleFileUpload = (e) => {
        const file = e.target.files[0]; if (!file) return;
        if (!file.type.startsWith('image/') && file.type !== 'application/pdf') return showToast("éæ³•æ ¼å¼ï¼šç³»ç»Ÿä»…æ”¯æŒæ¥çº³ PDF æˆ–å›¾åƒè§„èŒƒè¯æ˜", 'error'); 
        if (file.size > 2 * 1024 * 1024) return showToast("å‡ºäºæ•ˆèƒ½çº¦æŸï¼Œè§„åˆ™æ–‡ä»¶é…é¢é™åˆ¶åœ¨ 2MB ä»¥å†…", 'error'); 
        const reader = new FileReader();
        reader.onload = (ev) => setPdfFile({ name: file.name, base64: ev.target.result.split(',')[1], mimeType: file.type });
        reader.readAsDataURL(file);
      };

      const saveAiRules = async () => {
        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', currentClass), { 
            rulesText: aiRulesText, rulesPdfName: pdfFile.name, rulesPdfBase64: pdfFile.base64, rulesFileMimeType: pdfFile.mimeType || 'application/pdf'
          }, { merge: true });
          showToast("AI è£å†³æ ¸å¿ƒæ ‘å·²é‡æ„å¹¶å‘å…¨ç½‘åŒæ­¥å¹¿æ’­", 'success');
        } catch (error) { showToast("è§„åˆ™é”šç‚¹å›ºåŒ–å¼‚å¸¸", 'error'); }
      };

      const GlobalModals = () => (
        <React.Fragment>
          {toast.show && (
            <div className={`fixed top-6 right-6 z-[100] flex items-center gap-3 px-5 py-3.5 rounded-2xl shadow-2xl animate-in slide-in-from-top-4 duration-300 ${toast.type === 'error' ? 'bg-rose-50 border border-rose-200 text-rose-800' : 'bg-emerald-50 border border-emerald-200 text-emerald-800'}`}>
              {toast.type === 'error' ? <AlertCircle className="w-5 h-5" /> : <CheckCircle className="w-5 h-5" />}
              <span className="font-bold text-sm">{toast.message}</span>
            </div>
          )}
          {previewImage && (
            <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6 cursor-zoom-out" onClick={() => setPreviewImage(null)}>
              <img src={previewImage} className="max-w-full max-h-[85vh] rounded-2xl shadow-2xl border border-white/10" onClick={e => e.stopPropagation()} />
            </div>
          )}
          {isBatching && (
            <div className="fixed inset-0 z-[120] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
               <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl flex flex-col items-center max-w-sm w-full border border-indigo-50">
                  <div className="w-20 h-20 mb-8 relative">
                    <div className="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                    <div className="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                    <Sparkles className="absolute inset-0 m-auto w-8 h-8 text-indigo-600 animate-pulse" />
                  </div>
                  <h3 className="text-2xl font-black text-slate-800 mb-2 tracking-tighter">æ¨¡å‹æ·±å±‚è®¤çŸ¥æ¿€æ´»ä¸­</h3>
                  <p className="text-slate-400 text-sm mb-8 text-center leading-relaxed font-medium">ç³»ç»Ÿæ­£åœ¨æ’é˜Ÿè§£æ„å…¨ç­æ¯ä¸€ä½æˆå‘˜çš„å›¾æ–‡ä½è¯ææ–™...</p>
                  <p className="text-sm font-black text-indigo-700 bg-indigo-50 px-6 py-2 rounded-full tracking-tight">{batchProgress}</p>
               </div>
            </div>
          )}
          {confirmDialog.show && (
            <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                <h3 className="text-xl font-black text-slate-800 mb-3 flex items-center gap-2"><AlertTriangle className="w-6 h-6 text-rose-500" /> è¶…çº§æƒé™è­¦å‘ŠæŒ‡ä»¤</h3>
                <p className="text-slate-500 text-sm mb-8 font-medium leading-relaxed">{confirmDialog.message}</p>
                <div className="flex gap-3">
                  <button onClick={() => setConfirmDialog({show:false})} className="flex-1 py-3 text-sm font-bold text-slate-400 hover:bg-slate-50 rounded-xl transition-all">æ”¶èµ·å¹²é¢„</button>
                  <button onClick={confirmDialog.onConfirm} className="flex-1 py-3 text-sm font-bold text-white bg-rose-600 hover:bg-rose-700 rounded-xl shadow-lg shadow-rose-200 transition-all">æœæ–­ç²‰ç¢</button>
                </div>
              </div>
            </div>
          )}
        </React.Fragment>
      );

      if (viewState === 'lobby') {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 lg:p-10 relative overflow-hidden bg-slate-100">
            <GlobalModals />
            <div className="absolute -top-24 -left-24 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
            <div className="absolute -bottom-24 -right-24 w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
            <div className="bg-white rounded-[3rem] shadow-2xl p-10 lg:p-16 w-full max-w-6xl z-10 border border-white relative">
              <div className="flex flex-col items-center mb-16">
                <div className="p-5 bg-indigo-600 rounded-3xl mb-6 shadow-xl shadow-indigo-200 text-white animate-bounce-slow">
                  <Trophy className="w-12 h-12" />
                </div>
                <h1 className="text-4xl font-black text-slate-800 tracking-tighter">ç»¼åˆæµ‹è¯„ä¸å¥–å­¦é‡‘ç®¡ç†ç³»ç»Ÿ</h1>
                <p className="text-slate-400 mt-4 font-bold text-lg">æ™ºé¢†è¯„é€‰ Â· åŠ¨æ€åŒæ­¥ Â· æœºå™¨è§†è§‰æŸ¥éªŒ</p>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <div className="bg-slate-50 rounded-[2.5rem] p-8 border border-slate-200">
                  <h2 className="text-2xl font-black text-slate-800 mb-8 flex items-center gap-3">
                    <Users className="w-7 h-7 text-indigo-600" /> æ¥å…¥ç°æœ‰è¯„å®šæ¢çº½
                  </h2>
                  <div className="space-y-4 overflow-y-auto pr-2 max-h-[400px]">
                    {Object.keys(classesData).length === 0 ? (
                      <div className="text-center py-20 text-slate-300 font-bold italic">ç›®å‰å¤§å…æœªå‘ç°å¤„äºæ¿€æ´»çŠ¶æ€çš„ç­çº§èŠ‚ç‚¹...</div>
                    ) : (
                      Object.keys(classesData).map(cName => {
                        const count = studentsData.filter(s => s.className === cName).length;
                        return (
                          <button key={cName} onClick={() => initiateJoinClass(cName)} className="w-full text-left bg-white px-6 py-5 rounded-[1.5rem] border border-slate-200 hover:border-indigo-500 hover:shadow-xl transition-all flex justify-between items-center group">
                            <div>
                              <span className="font-black text-slate-700 block text-xl group-hover:text-indigo-600">{cName}</span>
                              <span className="text-xs text-slate-400 font-bold flex items-center gap-2 mt-1 uppercase tracking-widest"><Fingerprint className="w-3.5 h-3.5"/> è§¦å‘æ¡£æ¡ˆåŒ¹é…æµ</span>
                            </div>
                            <div className="text-right">
                              <div className="text-indigo-600 font-black text-lg">{count}</div>
                              <div className="text-[10px] text-slate-400 font-bold uppercase">Submitted</div>
                            </div>
                          </button>
                        );
                      })
                    )}
                  </div>
                </div>
                <div className="bg-gradient-to-br from-indigo-50 to-white rounded-[2.5rem] p-8 border border-indigo-100 shadow-sm">
                  <h2 className="text-2xl font-black text-slate-800 mb-8 flex items-center gap-3"><ShieldCheck className="w-7 h-7 text-indigo-600" /> ç®¡ç†å‘˜éƒ¨ç½²å…¨æ–°èŠ‚ç‚¹</h2>
                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-black text-slate-700 mb-2 ml-1">ç‹¬ç«‹ç¼–åˆ¶å…¨ç§°</label>
                      <input type="text" placeholder="å¡«å†™æ ‡å‡†çš„è¯„å®šç­çº§å" className="w-full px-5 py-4 rounded-2xl bg-white border border-slate-300 outline-none font-bold focus:ring-4 focus:ring-indigo-100 focus:border-indigo-600 transition-all" value={newClassNameInput} onChange={e => setNewClassNameInput(e.target.value)} />
                    </div>
                    <div>
                      <label className="block text-sm font-black text-slate-700 mb-2 ml-1">è¶…çº§å®¡è®¡ç§˜é’¥</label>
                      <input type="password" placeholder="è®¾ç½®é˜²ç¯¡æ”¹æ ¡éªŒå£ä»¤" className="w-full px-5 py-4 rounded-2xl bg-white border border-slate-300 outline-none font-bold focus:ring-4 focus:ring-indigo-100 focus:border-indigo-600 transition-all" value={newClassAdminPwdInput} onChange={e => setNewClassAdminPwdInput(e.target.value)} />
                    </div>
                    <div className="pt-6 border-t border-indigo-200/50">
                      <label className="block text-sm font-black text-slate-700 mb-3 ml-1">å®ä½“èº«ä»½åº“åŸºå»º (æ­¤æ­¥éª¤é˜»æ–­æ¨è¿›)</label>
                      <label className={`cursor-pointer flex flex-col items-center justify-center w-full py-8 bg-white border-2 border-dashed border-indigo-200 rounded-[2rem] hover:bg-indigo-50 hover:border-indigo-500 transition-all text-indigo-700 font-black ${isAiParsingRoster ? 'opacity-50 pointer-events-none' : ''}`}>
                        {isAiParsingRoster ? <Loader2 className="w-8 h-8 animate-spin" /> : <UploadCloud className="w-8 h-8 mb-2" />} 
                        {isAiParsingRoster ? 'åº•å±‚å¤šæ¨¡æ€æ¶æ„æ­£åœ¨è¯»å–è¡¨å•...' : 'è£…è½½äººå‘˜èŠ±åå†Œ (å›¾æ–‡å‡å¯)'}
                        <span className="text-xs text-slate-400 font-medium mt-1">ç³»ç»Ÿå·²å…·å¤‡å…ç–«è¡¨å¤´ä¸æ— æ•ˆæ®µè½çš„æ¸…æ´—èƒ½åŠ›</span>
                        <input type="file" accept=".csv, .txt, .xlsx, .xls, image/*" className="hidden" onChange={handleRosterUpload} disabled={isAiParsingRoster} />
                      </label>
                      {newClassRoster.length > 0 && !isAiParsingRoster && (
                         <div className="mt-4 text-sm font-black text-green-700 bg-green-50 px-5 py-3 rounded-2xl border border-green-200 flex items-center gap-3"><CheckCircle className="w-5 h-5"/> å®‰å…¨éš”ç¦»åº“å·²é”å®š {newClassRoster.length} äººçš„æ ¡éªŒåŸºå‡†</div>
                      )}
                    </div>
                    <button onClick={handleCreateClass} disabled={isAiParsingRoster} className={`w-full bg-slate-800 hover:bg-indigo-600 text-white font-black text-xl py-4 rounded-2xl shadow-xl shadow-slate-200 transition-all active:scale-95 ${isAiParsingRoster ? 'opacity-50 cursor-not-allowed' : ''}`}>å¼ºè¡Œæ¨è¿›ç”Ÿæˆåºåˆ—</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (viewState === 'login') {
        return (
          <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
            <GlobalModals />
            <div className="bg-white rounded-[3rem] shadow-2xl p-10 sm:p-14 w-full max-w-md border border-slate-100 relative overflow-hidden">
              <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-600/5 rounded-full -mr-16 -mt-16 pointer-events-none"></div>
              <button onClick={() => setViewState('lobby')} className="text-sm font-black text-slate-400 hover:text-indigo-600 mb-10 flex items-center gap-2 group">
                <div className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 group-hover:bg-indigo-50 transition-colors">&larr;</div> å›å½’å¤§åŒº
              </button>
              <h2 className="text-4xl font-black text-slate-800 mb-10 tracking-tighter">æ¢é’ˆæ¥å…¥<br/>{selectedClassToJoin}</h2>
              <div className="flex space-x-2 bg-slate-100 p-1.5 rounded-2xl mb-10">
                <button onClick={() => setLoginRoleTab('student')} className={`flex-1 py-3 text-sm font-black rounded-xl transition-all ${loginRoleTab === 'student' ? 'bg-white text-indigo-700 shadow-md' : 'text-slate-500 hover:text-slate-800'}`}>å—è¯„äººèŠ‚ç‚¹</button>
                <button onClick={() => setLoginRoleTab('admin')} className={`flex-1 py-3 text-sm font-black rounded-xl transition-all ${loginRoleTab === 'admin' ? 'bg-white text-indigo-700 shadow-md' : 'text-slate-500 hover:text-slate-800'}`}>æ€»æ§è°ƒåº¦å£</button>
              </div>
              <div className="space-y-6">
                {loginRoleTab === 'student' ? (
                  <React.Fragment>
                    <div><label className="block text-sm font-black text-slate-700 mb-2 ml-1">åç›®ä¿¡æ¯</label><input type="text" placeholder="ä¸¥æŸ¥èº«ä»½æŒ‡çº¹æ¯”å¯¹" className="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold focus:bg-white focus:border-indigo-600 transition-all" value={userNameInput} onChange={e => setUserNameInput(e.target.value)} /></div>
                    <div><label className="block text-sm font-black text-slate-700 mb-2 ml-1">æ¡£æ¡ˆæµæ°´ç  (å­¦å·)</label><input type="text" placeholder="å­—ç¬¦çº§ç²¾å‡†è§£ææ¯”å¯¹" className="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold focus:bg-white focus:border-indigo-600 transition-all" value={studentIdInput} onChange={e => setStudentIdInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} /></div>
                  </React.Fragment>
                ) : (
                  <div className="animate-in fade-in slide-in-from-right-2">
                    <label className="block text-sm font-black text-slate-700 mb-2 ml-1">æ¶æ„é˜²çº¿é€šè¡Œè¯</label><input type="password" placeholder="æœ€é«˜å®¡è®¡æƒé™æš—ç " className="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none font-bold focus:bg-white focus:border-indigo-600 transition-all" value={adminPwdInput} onChange={e => setAdminPwdInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} />
                  </div>
                )}
                <button onClick={handleLogin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xl py-4.5 rounded-2xl shadow-xl shadow-indigo-100 mt-6 transition-all active:scale-95">æˆäºˆæ ¸ç­¾å¹¶é€šè¡Œ</button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen flex flex-col bg-slate-50">
          <GlobalModals />
          <header className="bg-white border-b border-slate-200 sticky top-0 z-40 h-20 flex items-center shadow-sm">
            <div className="max-w-7xl mx-auto px-6 w-full flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Trophy className="w-6 h-6" /></div>
                <h1 className="text-2xl font-black text-slate-800 tracking-tighter uppercase">{currentClass}</h1>
              </div>
              <div className="flex items-center gap-4 sm:gap-8">
                <div className="hidden sm:flex flex-col items-end">
                  <span className="text-sm font-black text-slate-800 uppercase tracking-tighter">{currentUser}</span>
                  <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase">{currentUserRole} Vector</span>
                </div>
                <button onClick={handleLeaveClass} className="text-sm font-black text-rose-500 hover:bg-rose-50 px-4 py-2 rounded-xl transition-all border border-rose-100 uppercase">Terminate</button>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-6 w-full mt-8 flex space-x-3 p-2 bg-white shadow-xl shadow-slate-100 border border-slate-200 rounded-[2rem]">
            <button onClick={() => setActiveTab('ranking')} className={`flex-1 py-4 text-sm font-black rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-tighter ${activeTab === 'ranking' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50'}`}><Trophy className="w-4 h-4" /> ç»Ÿç­¹çŸ©é˜µæ¦œ</button>
            {currentUserRole === 'student' && <button onClick={initMyApplication} className={`flex-1 py-4 text-sm font-black rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-tighter ${activeTab === 'application' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50'}`}><Edit3 className="w-4 h-4" /> ä¸ªäººå·å®—åº“</button>}
            {currentUserRole === 'admin' && isReadOnly && <button className="flex-1 py-4 text-sm font-black rounded-2xl bg-amber-50 text-amber-700 flex items-center justify-center gap-2 uppercase tracking-tighter"><Eye className="w-4 h-4" /> è§‚æµ‹æ€: {formName}</button>}
            <button onClick={() => setActiveTab('ai-rules')} className={`flex-1 py-4 text-sm font-black rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-tighter ${activeTab === 'ai-rules' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50'}`}><Sparkles className="w-4 h-4" /> è£å†³æ¨¡å‹è§„èŒƒ</button>
          </div>

          <main className="max-w-7xl mx-auto px-6 w-full flex-1 py-10">
            {activeTab === 'ranking' && (
              <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden animate-in fade-in zoom-in-95 duration-300">
                {currentUserRole === 'admin' && (
                  <div className="bg-indigo-600 p-6 flex flex-col sm:flex-row items-center justify-between gap-6 shadow-inner">
                    <div className="text-white text-center sm:text-left">
                      <h3 className="text-lg font-black tracking-tight">æœºå™¨è§†è§‰å…¨ç›˜åˆ†æé˜Ÿåˆ—</h3>
                      <p className="text-xs text-indigo-100 font-bold mt-1 tracking-widest uppercase">Unresolved Stack: {currentStudents.filter(s=>s.bonusItems?.some(i=>i.aiStatus==='Pending'||!i.aiStatus)).length} candidates</p>
                    </div>
                    <button onClick={handleBatchAudit} className="bg-white text-indigo-600 hover:bg-indigo-50 px-8 py-3.5 rounded-2xl text-sm font-black shadow-xl transition-all active:scale-95 flex items-center gap-2 uppercase"><PlayCircle className="w-5 h-5" /> æ³¨å…¥æ‰¹å¤„ç†æ¨æ¼”ç®—åŠ›</button>
                  </div>
                )}
                <div className="p-8 flex flex-col xl:flex-row justify-between items-center gap-6 border-b border-slate-100">
                  <div>
                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">é«˜åº¦æ™ºèƒ½æ’ä½çŸ©é˜µ</h2>
                    <p className="text-sm text-slate-400 mt-2 font-bold tracking-widest uppercase">Global Score Synchronization Link</p>
                  </div>
                  <div className="flex gap-4">
                    <button onClick={exportTable} className="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-2xl text-sm font-black shadow-lg shadow-emerald-100 transition-all hover:bg-emerald-700 active:scale-95"><ListOrdered className="w-4 h-4" /> ç”ŸæˆæŠ¥å‘Šä½“ç³»(.xlsx)</button>
                    {currentUserRole === 'admin' && <button onClick={()=>{setConfirmDialog({show:true, message:"è¯¥æ‰§è¡ŒæŒ‡ä»¤å±äºæœ€é«˜æƒé™èŒƒç•´ï¼Œå°†æ°¸ä¹…ç²‰ç¢æ‰€æœ‰ç›¸å…³èŠ‚ç‚¹åŠå­ç”³æŠ¥è®°å½•ï¼Œä¸å¯é€†å›ã€‚ç¡®å®šè¦å‡€åŒ–æ•´ä¸ªç­çº§çš„ç½‘ä½“æ¶æ„å—ï¼Ÿ", onConfirm:handleDeleteClassByAdmin})}} className="p-3 bg-rose-50 text-rose-500 rounded-2xl hover:bg-rose-100 transition-colors"><Trash2 className="w-5 h-5"/></button>}
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50/80 text-slate-500 text-xs font-black uppercase tracking-[0.2em] border-b border-slate-200">
                      <tr><th className="px-8 py-6 text-center">Rank</th><th className="px-8 py-6">Identity Vector</th><th className="px-8 py-6">Origin</th><th className="px-8 py-6">Acc Bonus</th><th className="px-8 py-6 text-indigo-600">Scaled Offset</th><th className="px-8 py-6 text-slate-800">Final Mark</th><th className="px-8 py-6">AI Terminal</th><th className="px-8 py-6 text-center">Protocol</th></tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {rankedStudents.length === 0 ? (
                        <tr><td colSpan="8" className="px-8 py-20 text-center text-slate-300 font-bold italic text-lg tracking-widest uppercase">Null Sequence Detected.</td></tr>
                      ) : (
                        rankedStudents.map((s, idx) => (
                          <tr key={s.id} className={`${s.studentId === currentStudentId ? 'bg-indigo-50/50' : 'hover:bg-slate-50'} transition-all group`}>
                            <td className="px-8 py-6 text-center font-black text-slate-300 italic text-2xl group-hover:text-indigo-400">{idx+1}</td>
                            <td className="px-8 py-6"><div className="font-black text-slate-800 text-lg tracking-tight">{s.name}</div><div className="text-xs text-slate-400 font-bold tracking-widest mt-1">{s.studentId}</div></td>
                            <td className="px-8 py-6 font-bold text-slate-600">{s.originalGrade}</td>
                            <td className="px-8 py-6 font-bold text-slate-400">{s.rawBonus}</td>
                            <td className="px-8 py-6 font-black text-indigo-600 text-lg">+{s.scaledBonus}</td>
                            <td className="px-8 py-6 font-black text-2xl text-slate-800 tracking-tighter">{s.totalScore}</td>
                            <td className="px-8 py-6">{s.hasAiWarning ? <div className="text-rose-600 text-[10px] font-black border border-rose-200 bg-rose-50 px-3 py-1.5 rounded-full flex items-center gap-1.5 w-max uppercase tracking-tighter">Issue Detected</div> : <div className="text-emerald-600 text-[10px] font-black border border-emerald-200 bg-emerald-50 px-3 py-1.5 rounded-full flex items-center gap-1.5 w-max uppercase tracking-tighter">Verified Integrity</div>}</td>
                            <td className="px-8 py-6 text-center"><button onClick={()=>loadStudentFormReadOnly(s)} className="text-indigo-600 bg-white border-2 border-indigo-100 hover:border-indigo-600 font-black px-6 py-2.5 rounded-2xl transition-all shadow-sm uppercase text-xs tracking-tighter">Drill Down</button></td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {activeTab === 'application' && (
              <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 p-10 relative overflow-hidden animate-in fade-in slide-in-from-bottom-8 duration-300">
                {isReadOnly && <div className="absolute top-0 left-0 w-full bg-amber-50 text-amber-800 text-[10px] py-3 px-10 font-black tracking-[0.2em] flex items-center gap-2 border-b border-amber-200 uppercase"><Eye className="w-4 h-4" /> Blocked Terminal: Archive Reading Only</div>}
                <div className={`mb-12 ${isReadOnly ? 'mt-10' : ''}`}><h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase">{isReadOnly ? `é”å®šå·å®—: ${formName}` : 'ç¼–è¯‘æˆ‘çš„ç”³æŠ¥å›¾è°±'}</h2></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 bg-slate-50 p-8 rounded-[2rem] border border-slate-100 shadow-inner">
                  <div><label className="block text-xs font-black text-slate-400 mb-3 ml-1 uppercase tracking-widest">Locked Identity</label><input type="text" value={formName} disabled className="w-full px-6 py-4 rounded-2xl border border-transparent bg-slate-200 text-slate-600 font-black cursor-not-allowed" /></div>
                  <div><label className="block text-xs font-black text-slate-700 mb-3 ml-1 uppercase tracking-widest">Base Ground Truth Score (Mandatory)</label><input type="number" value={formOriginalGrade} onChange={e=>setFormOriginalGrade(e.target.value)} disabled={isReadOnly} className={`w-full px-6 py-4 rounded-2xl border font-black text-xl outline-none transition-all ${isReadOnly ? 'bg-slate-200 cursor-not-allowed' : 'bg-white border-slate-300 focus:border-indigo-600 focus:ring-4 focus:ring-indigo-50 shadow-md'}`} /></div>
                </div>
                <div className="mb-8 flex items-center justify-between"><h3 className="text-xl font-black text-slate-800 flex items-center gap-3 uppercase tracking-tighter"><BookOpen className="w-6 h-6 text-indigo-600" /> åŠ åˆ†æ’æ§½è£…è½½é˜µåˆ—</h3>{!isReadOnly && <button onClick={()=>{setFormBonusItems([...formBonusItems, {id: Date.now(), points:'', type:'', description:'', aiStatus: 'Pending'}])}} className="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-2xl font-black shadow-xl hover:bg-indigo-700 transition-all uppercase text-sm"><PlusCircle className="w-4 h-4" /> Mount Item Block</button>}</div>
                <div className="space-y-6">
                  {formBonusItems.length === 0 ? (
                    <div className="text-center py-20 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 text-slate-300 font-bold uppercase tracking-widest">Zero Bonus Entities Provisioned</div>
                  ) : (
                    formBonusItems.map(item => (
                      <div key={item.id} className={`p-8 rounded-[2rem] border-2 transition-all group ${isReadOnly ? 'bg-slate-50/50 border-slate-100' : 'bg-white border-slate-200 hover:border-indigo-400 hover:shadow-xl'}`}>
                        {!isReadOnly && <button onClick={()=>setFormBonusItems(formBonusItems.filter(i=>i.id!==item.id))} className="float-right text-slate-300 hover:text-rose-500 transition-colors p-2"><Trash2 className="w-6 h-6" /></button>}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                          <div><label className="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-[0.2em]">Numeric Float</label><input type="number" step="0.01" value={item.points} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, points: e.target.value}:i))} disabled={isReadOnly} className="w-full px-4 py-3 rounded-xl border text-lg font-black bg-slate-50 border-slate-100 outline-none focus:bg-white focus:border-indigo-600 transition-all" /></div>
                          <div><label className="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-[0.2em]">Typology String</label><input type="text" value={item.type} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, type: e.target.value}:i))} disabled={isReadOnly} className="w-full px-4 py-3 rounded-xl border font-bold bg-slate-50 border-slate-100 outline-none focus:bg-white focus:border-indigo-600 transition-all" /></div>
                          <div className="md:col-span-2"><label className="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-[0.2em]">Logic Proof Outline</label><input type="text" value={item.description} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, description: e.target.value}:i))} disabled={isReadOnly} className="w-full px-4 py-3 rounded-xl border font-bold bg-slate-50 border-slate-100 outline-none focus:bg-white focus:border-indigo-600 transition-all" /></div>
                        </div>
                        <div className="flex flex-wrap items-center gap-4 pt-6 border-t border-slate-100">
                          {!isReadOnly && <label className="cursor-pointer px-5 py-2.5 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-black border border-indigo-200 hover:bg-indigo-100 transition-all flex items-center gap-2 uppercase tracking-tighter"><UploadCloud className="w-4 h-4" />Inject Binary Buffer<input type="file" accept="image/*" className="hidden" onChange={e=>{const f=e.target.files[0];if(f){compressImage(f, b64=>{setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, materialName: f.name, materialBase64: b64, aiStatus: 'Pending'}:i));});}}} /></label>}
                          {item.materialName ? <button onClick={()=>item.materialBase64 && setPreviewImage(item.materialBase64)} className="text-xs font-black text-slate-500 bg-slate-100 px-5 py-2.5 rounded-xl border border-slate-200 hover:text-indigo-600 transition-all flex items-center gap-2 truncate max-w-[250px] uppercase tracking-tighter"><FileText className="w-4 h-4 flex-shrink-0"/>{item.materialName}</button> : <span className="text-xs font-bold text-slate-300 italic tracking-widest">Null Base64 Payload</span>}
                          {item.aiStatus && item.aiStatus !== 'Pending' && <div className={`ml-auto text-[10px] font-black px-4 py-2 rounded-xl border-2 flex items-center gap-2 shadow-sm uppercase ${item.aiStatus==='Approve'?'bg-emerald-50 text-emerald-700 border-emerald-200':'bg-amber-50 text-amber-700 border-amber-200'}`}>{item.aiStatus==='Approve'?'AI SECURE FLAG':'HUMAN BYPASS REQUIRED'}<span className="opacity-40 font-bold ml-1">| {item.aiReason}</span></div>}
                        </div>
                      </div>
                    ))
                  )}
                </div>
                {!isReadOnly && <div className="mt-12 flex justify-end"><button onClick={handleSaveStudent} className="flex items-center gap-3 bg-slate-900 hover:bg-indigo-600 text-white px-12 py-5 rounded-[1.5rem] font-black text-lg transition-all shadow-2xl active:scale-95 uppercase tracking-tighter"><Save className="w-6 h-6" /> Flash Sync to Cloud Space</button></div>}
              </div>
            )}

            {activeTab === 'ai-rules' && (
              <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 p-10 max-w-5xl mx-auto overflow-hidden relative animate-in fade-in duration-500">
                <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><Sparkles className="w-32 h-32" /></div>
                <div className="flex items-center gap-6 mb-12 border-b border-slate-100 pb-10"><div className="p-4 bg-purple-600 text-white rounded-3xl shadow-xl shadow-purple-200"><Sparkles className="w-10 h-10" /></div><div><h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase">Algorithm Bias Override</h2><p className="text-slate-400 font-bold mt-2 text-lg italic tracking-tighter uppercase">åä½œå¹²é¢„æœºåˆ¶ï¼šç”±æœ¬ç­å…¨ä½“æˆå‘˜ååŒå®Œå–„çš„è¯„åˆ¤ç½‘ç»œå›¾è°±ã€‚</p></div></div>
                
                <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
                  <label className="block text-sm font-black text-slate-700 mb-3 flex items-center gap-2"><BookOpen className="w-4 h-4 text-slate-400"/>è§†è§‰å‚ç…§åæ ‡åº•å›¾ (ä»… PDF/OCRå›¾ä¼ )</label>
                  <div className="flex flex-col sm:flex-row sm:items-center gap-4">
                    {currentUserRole === 'admin' && (
                      <button onClick={() => fileInputRef.current?.click()} className="flex items-center justify-center gap-2 px-5 py-3 bg-white border border-slate-300 rounded-xl text-sm font-bold text-slate-700 hover:bg-slate-100 transition-colors shadow-sm w-full sm:w-auto">
                        <UploadCloud className="w-4 h-4 text-indigo-600" /> è½½å…¥ç›–ç« è§„èŒƒæµæ–‡ä»¶
                      </button>
                    )}
                    <input type="file" accept="application/pdf, image/*" ref={fileInputRef} onChange={handleRuleFileUpload} className="hidden" />
                    {pdfFile.name ? (
                      <div className="flex items-center gap-2 px-4 py-3 bg-emerald-50 text-emerald-800 border border-emerald-200 rounded-xl text-sm w-full sm:w-auto">
                        <FileText className="w-5 h-5 flex-shrink-0 text-emerald-500" /> 
                        <span className="font-bold truncate max-w-[200px]">{pdfFile.name}</span>
                        <span className="text-[10px] bg-emerald-200/50 text-emerald-700 px-2 py-1 rounded-md font-bold ml-auto uppercase tracking-widest">Anchored Matrix</span>
                      </div>
                    ) : (<span className="text-xs font-bold text-slate-400 uppercase tracking-widest italic">Matrix is Void.</span>)}
                  </div>
                </div>

                <div className="mb-12"><label className="block text-lg font-black text-slate-800 mb-5 flex items-center gap-3"><Edit3 className="w-6 h-6 text-purple-600"/> å¼‚å¸¸é€»è¾‘è±å…åˆ†æ”¯åŸŸ</label><textarea rows="15" value={aiRulesText} onChange={e=>setAiRulesText(e.target.value)} className="w-full px-8 py-8 rounded-[2rem] border-2 border-slate-200 focus:border-purple-600 bg-slate-50 font-medium leading-relaxed outline-none transition-all shadow-inner text-slate-700 placeholder:italic" placeholder="å†™ä¸‹é€»è¾‘å¼ºåˆ¶è¦†ç›–èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼š1.ç‰¹å®šé¡¹ç›®å…é™¤è¯æ®é—­ç¯ã€‚ 2.ç‰¹æƒäººå…ç–«æ¸…å•ã€‚"></textarea></div>
                <div className="flex justify-end pt-4"><button onClick={saveAiRules} className="flex items-center justify-center gap-3 bg-purple-600 hover:bg-purple-700 text-white px-12 py-5 rounded-[1.5rem] font-black text-xl transition-all shadow-2xl shadow-purple-100 active:scale-95 uppercase tracking-tighter"><Save className="w-6 h-6" /> Deploy Tensor Adjustments</button></div>
              </div>
            )}
          </main>
          <footer className="py-10 text-center text-slate-300 font-black text-[10px] tracking-[0.5em] uppercase">Neural Network Â· Cloud Frame Â· Logic Bound</footer>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    if (!isConfigValid) {
      root.render(<ConfigErrorUI />);
    } else {
      root.render(<App />);
    }
  </script>
</body>
</html>
