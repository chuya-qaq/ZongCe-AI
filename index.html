<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç»¼åˆæµ‹è¯„ä¸å¥–å­¦é‡‘ç®¡ç†ç³»ç»Ÿ</title>
  
  <!-- æ ¸å¿ƒä¾èµ–åº“ (å»é™¤äº†å¯¼è‡´æ ·å¼è¢«æ‹¦æˆªçš„å±æ€§ï¼Œæ¢å¤åŸç”ŸåŠ è½½) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ES Modules æ˜ å°„è¡¨ -->
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js",
      "xlsx": "https://esm.sh/xlsx@0.18.5"
    }
  }
  </script>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Trophy, Users, BookOpen, PlusCircle, Trash2, Save, 
      UploadCloud, AlertCircle, CheckCircle, Clock, Edit3, 
      Sparkles, FileDown, Eye, FileText, AlertTriangle, LogOut, Loader2, ShieldCheck, ListOrdered, Fingerprint, PlayCircle, Settings
    } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from 'firebase/firestore';
    import * as XLSX from 'xlsx';

    // ==========================================
    // ğŸš€ æ•°æ®åº“é…ç½®åŒº
    // ==========================================
    const localFirebaseConfig = {
      apiKey: "åœ¨æ­¤å¡«å…¥ä½ çš„ apiKey",
      authDomain: "åœ¨æ­¤å¡«å…¥ä½ çš„ authDomain",
      projectId: "åœ¨æ­¤å¡«å…¥ä½ çš„ projectId",
      storageBucket: "åœ¨æ­¤å¡«å…¥ä½ çš„ storageBucket",
      messagingSenderId: "åœ¨æ­¤å¡«å…¥ä½ çš„ messagingSenderId",
      appId: "åœ¨æ­¤å¡«å…¥ä½ çš„ appId"
    };

    let envConfig = null;
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
      try { envConfig = JSON.parse(__firebase_config); } catch (e) {}
    }
    
    const finalConfig = envConfig || localFirebaseConfig;
    const isConfigValid = finalConfig && finalConfig.apiKey && !finalConfig.apiKey.includes("åœ¨æ­¤å¡«å…¥");

    let app, auth, db;
    if (isConfigValid) {
      try {
        app = initializeApp(finalConfig);
        auth = getAuth(app);
        db = getFirestore(app);
      } catch (e) { console.error(e); }
    }
    
    const globalAppId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'zongce-app';
    const aiApiKey = "sk-gjzyakonhvumcdbirrvpghlyplwyxbxqthsqefoaqonljkmw";

    const fetchWithRetry = async (url, options, retries = 3) => {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (err) {
          if (i === retries - 1) throw err;
          await new Promise(res => setTimeout(res, 1500));
        }
      }
    };

    // --- æœªé…ç½®æ—¶çš„æ‹¦æˆªé¡µé¢ ---
    const ConfigErrorUI = () => (
      <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900">
        <div className="max-w-md w-full bg-white rounded-2xl p-8 shadow-2xl">
          <div className="flex justify-center mb-6"><div className="p-4 bg-amber-100 rounded-full"><Settings className="w-12 h-12 text-amber-600 animate-spin" /></div></div>
          <h2 className="text-2xl font-bold text-center mb-4">éœ€è¦é…ç½® Firebase æ•°æ®åº“</h2>
          <p className="text-slate-600 text-sm mb-6 text-center">ä¸ºäº†å¯ç”¨äº‘ç«¯å­˜å‚¨å’Œæ’ååŠŸèƒ½ï¼Œè¯·é…ç½®æ‚¨çš„æ•°æ®åº“å‚æ•°ã€‚</p>
          <ol className="text-sm text-slate-700 space-y-3 list-decimal pl-4">
            <li>å‰å¾€ <b>firebase.google.com</b> åˆ›å»ºé¡¹ç›®ã€‚</li>
            <li>åœ¨è®¾ç½®ä¸­è·å– Web SDK é…ç½®ã€‚</li>
            <li>å°†å‚æ•°æ›¿æ¢åˆ° <b>index.html</b> ç¬¬ 47 è¡Œçš„ <b>localFirebaseConfig</b> ä¸­ã€‚</li>
          </ol>
        </div>
      </div>
    );

    const App = () => {
      const [user, setUser] = useState(null);
      const [isDbReady, setIsDbReady] = useState(false);
      const [dbError, setDbError] = useState('');
      const [classesData, setClassesData] = useState({});
      const [studentsData, setStudentsData] = useState([]);
      const [currentClass, setCurrentClass] = useState(null);
      const [currentUser, setCurrentUser] = useState(''); 
      const [currentStudentId, setCurrentStudentId] = useState(''); 
      const [currentUserRole, setCurrentUserRole] = useState(''); 
      const [viewState, setViewState] = useState('lobby'); 
      const [activeTab, setActiveTab] = useState('ranking'); 
      
      const [newClassNameInput, setNewClassNameInput] = useState('');
      const [newClassAdminPwdInput, setNewClassAdminPwdInput] = useState('');
      const [newClassRoster, setNewClassRoster] = useState([]);
      const [isAiParsingRoster, setIsAiParsingRoster] = useState(false); 
      
      const [selectedClassToJoin, setSelectedClassToJoin] = useState('');
      const [loginRoleTab, setLoginRoleTab] = useState('student'); 
      const [userNameInput, setUserNameInput] = useState('');
      const [studentIdInput, setStudentIdInput] = useState('');
      const [adminPwdInput, setAdminPwdInput] = useState('');
      
      const [formName, setFormName] = useState('');
      const [formOriginalGrade, setFormOriginalGrade] = useState('');
      const [formBonusItems, setFormBonusItems] = useState([]);
      const [isReadOnly, setIsReadOnly] = useState(false); 
      const [aiRulesText, setAiRulesText] = useState('');
      const [pdfFile, setPdfFile] = useState({ name: '', base64: '', mimeType: '' });
      const [isBatching, setIsBatching] = useState(false);
      const [batchProgress, setBatchProgress] = useState('');
      const fileInputRef = useRef(null);
      const [previewImage, setPreviewImage] = useState(null); 
      const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
      const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null });

      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) { setDbError('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®è®¤å·²å¼€å¯åŒ¿åç™»å½•'); }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user || !db) return;
        const classesRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'classes');
        const unsubClasses = onSnapshot(classesRef, (snapshot) => {
          const newClasses = {};
          snapshot.forEach(doc => { newClasses[doc.id] = doc.data(); });
          setClassesData(newClasses);
        });
        const studentsRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'students');
        const unsubStudents = onSnapshot(studentsRef, (snapshot) => {
          const newStudents = [];
          snapshot.forEach(doc => { newStudents.push({ id: doc.id, ...doc.data() }); });
          setStudentsData(newStudents);
          setIsDbReady(true);
        });
        return () => { unsubClasses(); unsubStudents(); };
      }, [user]);

      const showToast = (message, type = 'success') => {
        setToast({ show: true, message, type });
        setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
      };

      const compressImage = (file, callback) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 1200;
            let width = img.width; let height = img.height;
            if (width > MAX_WIDTH) { height = Math.round((height * MAX_WIDTH) / width); width = MAX_WIDTH; }
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.65));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      };

      const currentStudents = useMemo(() => studentsData.filter(s => s.className === currentClass), [currentClass, studentsData]);
      
      const rankedStudents = useMemo(() => {
        if (currentStudents.length === 0) return [];
        const withRaw = currentStudents.map(s => ({
          ...s, rawBonus: s.bonusItems?.reduce((sum, item) => sum + (parseFloat(item.points) || 0), 0) || 0
        }));
        const maxRaw = Math.max(...withRaw.map(s => s.rawBonus), 0);
        return withRaw.map(s => {
          const scaled = maxRaw > 0 ? (s.rawBonus / maxRaw) * 3 : 0;
          return {
            ...s, scaledBonus: scaled.toFixed(4),
            totalScore: (parseFloat(s.originalGrade || 0) + scaled).toFixed(2),
            hasAiWarning: s.bonusItems?.some(i => i.aiStatus === 'Reject' || i.aiStatus === 'Manual Review' || !i.aiStatus || i.aiStatus === 'Pending')
          };
        }).sort((a, b) => b.totalScore - a.totalScore);
      }, [currentStudents]);

      // --- AI æå–åå• ---
      const handleRosterUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        setIsAiParsingRoster(true); showToast("æ­£åœ¨æå–åå•ï¼Œè¯·ç¨å€™...", 'success');
        try {
          let textPayload = [];
          if (file.type.startsWith('image/')) {
            const b64 = await new Promise(r => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(file); });
            textPayload = [{ type: "text", text: "æå–å›¾ç‰‡ä¸­çš„æ‰€æœ‰å­¦ç”Ÿå§“åå’Œå­¦å·å¯¹ã€‚å¿…é¡»ä»…è¾“å‡ºåˆæ³•çš„ JSON æ•°ç»„ï¼Œå½¢å¦‚ [{\"name\":\"å¼ ä¸‰\",\"studentId\":\"01\"}]ã€‚ä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—ï¼" }, { type: "image_url", image_url: { url: b64 } }];
          } else {
            const buffer = await file.arrayBuffer();
            const wb = XLSX.read(buffer);
            const csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]);
            const safePrompt = "åˆ†æä»¥ä¸‹è¡¨æ ¼æ•°æ®ï¼Œæå–æ‰€æœ‰çš„å§“åå’Œå­¦å·å¯¹ã€‚\nå¿…é¡»ä»…è¾“å‡ºåˆæ³•çš„ JSON æ•°ç»„æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™æ–‡å­—ï¼š\n" + csv.substring(0, 10000);
            textPayload = [{ type: "text", text: safePrompt }];
          }
          const res = await fetchWithRetry(`https://api.siliconflow.cn/v1/chat/completions`, {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiApiKey}` },
            body: JSON.stringify({ model: "THUDM/GLM-4.1V-9B-Thinking", messages: [{ role: "user", content: textPayload }] })
          });
          
          let rawContent = res.choices?.[0]?.message?.content || "";
          let cleanContent = rawContent.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
          const jsonArrayMatch = cleanContent.match(/\[[\s\S]*\]/);
          
          let list = [];
          if (jsonArrayMatch) { list = JSON.parse(jsonArrayMatch[0]); } 
          else {
            cleanContent = cleanContent.replace(/```json/gi, '').replace(/```/g, '').trim();
            const parsed = JSON.parse(cleanContent);
            list = Array.isArray(parsed) ? parsed : (parsed.students || parsed.data || []);
          }

          if (list.length === 0) throw new Error("æœªæ‰¾åˆ°äººå‘˜æ•°æ®");
          setNewClassRoster(list);
          showToast(`æˆåŠŸå¯¼å…¥ ${list.length} åå­¦ç”Ÿåå•`, 'success');
        } catch (error) { 
          showToast("è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼", 'error'); 
        } finally { setIsAiParsingRoster(false); e.target.value = ''; }
      };

      const handleCreateClass = async () => {
        const cName = newClassNameInput.trim();
        if (!cName || classesData[cName]) return showToast("ç­çº§åç§°ä¸èƒ½ä¸ºç©ºæˆ–å·²å­˜åœ¨", 'error');
        if (!newClassAdminPwdInput.trim()) return showToast("ç®¡ç†å‘˜å¯†ç ä¸èƒ½ä¸ºç©º", 'error');
        if (newClassRoster.length === 0) return showToast("å¿…é¡»å…ˆå¯¼å…¥ç­çº§åå•", 'error');

        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', cName), {
            rulesText: "æš‚æ— é™„åŠ è§„åˆ™", rulesPdfBase64: "", rulesPdfName: "", rulesFileMimeType: "application/pdf", 
            adminPwd: newClassAdminPwdInput.trim(), roster: newClassRoster
          });
          setNewClassNameInput(''); setNewClassAdminPwdInput(''); setNewClassRoster([]);
          showToast("ç­çº§åˆ›å»ºæˆåŠŸï¼", 'success');
        } catch { showToast("åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ", 'error'); }
      };

      const initiateJoinClass = (cName) => {
        setSelectedClassToJoin(cName);
        setUserNameInput(''); setStudentIdInput(''); setAdminPwdInput('');
        setLoginRoleTab('student'); setViewState('login');
      };

      const handleLogin = () => {
        const classData = classesData[selectedClassToJoin];
        if (!classData) return showToast("ç­çº§æ•°æ®å¼‚å¸¸", 'error');

        if (loginRoleTab === 'student') {
          if (!userNameInput.trim() || !studentIdInput.trim()) return showToast("å§“åå’Œå­¦å·ä¸èƒ½ä¸ºç©º", 'error');
          const isMatch = (classData.roster || []).find(r => String(r.name).trim() === userNameInput.trim() && String(r.studentId).trim() === studentIdInput.trim());
          if (!isMatch) return showToast("éªŒè¯å¤±è´¥ï¼šæ‚¨çš„å§“åæˆ–å­¦å·ä¸åœ¨æœ¬ç­åå•ä¸­", 'error');
          
          setCurrentUser(userNameInput.trim()); setCurrentStudentId(studentIdInput.trim()); setCurrentUserRole('student');
        } else {
          if (adminPwdInput.trim() !== classData.adminPwd) return showToast("ç®¡ç†å‘˜å¯†ç é”™è¯¯", 'error');
          setCurrentUser('ç®¡ç†å‘˜'); setCurrentStudentId('ADMIN'); setCurrentUserRole('admin');
        }
        setAiRulesText(classData.rulesText || ''); 
        setPdfFile({ name: classData.rulesPdfName || '', base64: classData.rulesPdfBase64 || '', mimeType: classData.rulesFileMimeType || 'application/pdf' });
        setViewState('dashboard');
      };

      const handleLeaveClass = () => {
        setCurrentClass(null); setCurrentUser(''); setCurrentStudentId(''); setCurrentUserRole('');
        setViewState('lobby');
      };

      const handleDeleteClassByAdmin = () => {
        setConfirmDialog({
          show: true, message: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç­çº§åŠå…¶æ‰€æœ‰å­¦ç”Ÿçš„ç”³æŠ¥æ•°æ®ï¼ä¸å¯æ¢å¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ",
          onConfirm: async () => {
            try {
              const studentsToDelete = studentsData.filter(s => s.className === currentClass);
              for (const s of studentsToDelete) await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', s.id));
              await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', currentClass));
              handleLeaveClass(); setConfirmDialog({ show: false, message: '', onConfirm: null });
              showToast("ç­çº§å·²å½»åº•åˆ é™¤", 'success');
            } catch (error) { showToast("åˆ é™¤å¤±è´¥", 'error'); }
          }
        });
      };

      const handleSaveStudent = async () => {
        if (!formOriginalGrade) return showToast("åŸå§‹æˆç»©å¿…å¡«", 'error');
        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', `${currentClass}_${currentStudentId}`), {
            className: currentClass, name: currentUser, studentId: currentStudentId,
            originalGrade: formOriginalGrade, bonusItems: formBonusItems, lastModified: new Date().toLocaleString()
          });
          showToast("æ•°æ®ä¿å­˜æˆåŠŸï¼AIå®¡æ ¸å°†ç”±ç®¡ç†å‘˜ç»Ÿä¸€è¿›è¡Œ", 'success'); setActiveTab('ranking');
        } catch { showToast("ä¿å­˜å¤±è´¥", 'error'); }
      };

      const processAI = async (items, studentName) => {
        const updated = [...items];
        const rules = classesData[currentClass]?.rulesText || '';
        const pdf = classesData[currentClass]?.rulesPdfBase64 || '';
        const mime = classesData[currentClass]?.rulesFileMimeType || 'application/pdf';
        
        for (let i = 0; i < updated.length; i++) {
          const it = updated[i];
          if (it.aiStatus !== 'Pending' && it.aiStatus) continue;
          if (!it.points || !it.description) continue;

          const prompt = "ä½ æ˜¯ä¸€ä¸ªæåº¦ä¸¥è°¨çš„å¤§å­¦å¥–å­¦é‡‘å®¡æ ¸AIã€‚\n" +
            "ã€å½“å‰å®¡æ ¸å­¦ç”Ÿã€‘: " + studentName + "\n" +
            "ã€è¯„åˆ†ç»†åˆ™ã€‘: " + rules + "\n" +
            "ã€åŠ åˆ†ç”³æŠ¥ã€‘: ç”³è¯· " + it.points + " åˆ†; ç±»å‹: " + it.type + "; æè¿°: " + it.description + "\n" +
            "ã€ææ–™è¯æ˜ã€‘: " + (it.materialName ? "å·²ä¸Šä¼ å›¾ç‰‡(è¯·æ ¸å®å›¾ç‰‡ä¸æè¿°æ˜¯å¦ç›¸ç¬¦)" : "æœªä¸Šä¼ ææ–™") + "\n\n" +
            "ã€å®¡æ ¸è§„èŒƒã€‘:\n" +
            "1. é˜²ç‰¹æƒæ³›åŒ–ï¼šå¦‚æœç»†åˆ™ä¸­æåˆ°æŸç‰¹å®šåŒå­¦ï¼ˆå¦‚å¼ ä¸‰ï¼‰å¯å…äº¤ææ–™ç­‰ç‰¹æƒï¼Œå¿…é¡»ä¸¥æ ¼æ¯”å¯¹ä¸Šæ–¹ã€å½“å‰å®¡æ ¸å­¦ç”Ÿã€‘çš„åå­—ï¼Œä¸¥ç¦å¼ å† ææˆ´ï¼\n" +
            "2. è¯æ®è¦æ±‚ï¼šå¦‚æœªä¸Šä¼ ææ–™ä¸”ä¸åœ¨è±å…åå•å†…ï¼Œå¿…é¡»é©³å›(Reject)æˆ–è½¬äººå·¥(Manual Review)ã€‚\n" +
            "3. åªå…è®¸è¾“å‡ºåˆæ³•çš„ JSON æ ¼å¼ï¼š\n" +
            "{\"status\": \"Approve\"|\"Reject\"|\"Manual Review\", \"reason\": \"åœ¨æ­¤å†™æ˜åŸå› \"}";

          try {
            const content = [{ type: "text", text: prompt }];
            if (pdf) content.push({ type: "image_url", image_url: { url: `data:${mime};base64,${pdf}` } });
            if (it.materialBase64) content.push({ type: "image_url", image_url: { url: it.materialBase64 } });
            
            const res = await fetchWithRetry(`https://api.siliconflow.cn/v1/chat/completions`, {
              method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiApiKey}` },
              body: JSON.stringify({ model: "THUDM/GLM-4.1V-9B-Thinking", messages: [{ role: "user", content }] })
            });
            
            let rawResult = res.choices?.[0]?.message?.content || '{"status": "Manual Review", "reason": "æœªæ”¶åˆ°æœ‰æ•ˆå›å¤"}';
            let cleanResult = rawResult.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
            const jsonObjMatch = cleanResult.match(/\{[\s\S]*\}/);
            let decision = jsonObjMatch ? JSON.parse(jsonObjMatch[0]) : JSON.parse(cleanResult.replace(/```json/gi, '').replace(/```/g, '').trim());
            updated[i].aiStatus = decision.status; updated[i].aiReason = decision.reason;
          } catch (e) { 
            updated[i].aiStatus = 'Manual Review'; updated[i].aiReason = 'APIå¼‚å¸¸'; 
          }
        }
        return updated;
      };

      const handleBatchAudit = async () => {
        const targets = currentStudents.filter(s => s.bonusItems?.some(i => i.aiStatus === 'Pending' || !i.aiStatus));
        if (!targets.length) return showToast("å½“å‰ç­çº§æ²¡æœ‰ä»»ä½•å¾…å®¡æ ¸çš„é¡¹ç›®", 'success');
        
        setIsBatching(true);
        for (let i = 0; i < targets.length; i++) {
          const s = targets[i]; 
          setBatchProgress(`æ­£åœ¨å®¡æ ¸: ${s.name} (${i+1}/${targets.length})`);
          const items = await processAI(s.bonusItems, s.name);
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'students', `${currentClass}_${s.studentId}`), { ...s, bonusItems: items });
          if (i < targets.length - 1) await new Promise(r => setTimeout(r, 2500));
        }
        setIsBatching(false); showToast("æ‰¹é‡æµæ°´çº¿å®¡æ ¸å®Œæˆï¼", 'success');
      };

      const exportTable = () => {
        if (!rankedStudents.length) return showToast("å½“å‰æ²¡æœ‰æ•°æ®å¯å¯¼å‡º", 'error');
        const aoa = [[`${currentClass}ç»¼æµ‹åŠ åˆ†æ˜ç»†è¡¨`], [], ["æ’å", "å§“å", "å­¦å·", "åŸå§‹æˆç»©", "å‚ä¸æ´»åŠ¨", "æ´»åŠ¨åˆ†æ•°", "æ€»ç”³æŠ¥åˆ†", "æŠ˜ç®—åŠ åˆ†", "AIå®¡æ ¸çŠ¶æ€"]];
        rankedStudents.forEach((s, idx) => {
          const items = s.bonusItems?.length ? s.bonusItems : [{ description: 'æ— åŠ åˆ†é¡¹', points: 0, aiStatus: 'æ— ' }];
          items.forEach((it, i) => {
            aoa.push([ i===0?idx+1:'', i===0?s.name:'', i===0?s.studentId:'', i===0?s.originalGrade:'', it.description, it.points, i===0?s.rawBonus:'', i===0?s.scaledBonus:'', it.aiStatus ]);
          });
        });
        const ws = XLSX.utils.aoa_to_sheet(aoa); ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "åŠ åˆ†æ˜ç»†");
        XLSX.writeFile(wb, `${currentClass}_åŠ åˆ†è¯¦ç»†æ˜ç»†.xlsx`);
      };

      const initMyApplication = () => {
        const me = currentStudents.find(s => s.studentId === currentStudentId);
        setIsReadOnly(false); setFormName(currentUser);
        if (me) { setFormOriginalGrade(me.originalGrade); setFormBonusItems(me.bonusItems || []); } 
        else { setFormOriginalGrade(''); setFormBonusItems([]); }
        setActiveTab('application');
      };

      const loadStudentFormReadOnly = (student) => {
        if (student.studentId === currentStudentId) return initMyApplication();
        setFormName(student.name); setFormOriginalGrade(student.originalGrade); setFormBonusItems(student.bonusItems || []);
        setIsReadOnly(true); setActiveTab('application');
      };

      const updateBonusItem = (id, field, value) => {
        setFormBonusItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value, aiStatus: 'Pending', aiReason: '' } : item));
      };
      const removeBonusItem = (id) => { setFormBonusItems(prev => prev.filter(item => item.id !== id)); };

      const handleRuleFileUpload = (e) => {
        const file = e.target.files[0]; if (!file) return;
        if (!file.type.startsWith('image/') && file.type !== 'application/pdf') return showToast("ä»…æ”¯æŒ PDF æˆ–å›¾ç‰‡æ–‡ä»¶", 'error'); 
        if (file.size > 2 * 1024 * 1024) return showToast("è§„åˆ™æ–‡ä»¶ä¸èƒ½è¶…è¿‡ 2MB", 'error'); 
        const reader = new FileReader();
        reader.onload = (ev) => setPdfFile({ name: file.name, base64: ev.target.result.split(',')[1], mimeType: file.type });
        reader.readAsDataURL(file);
      };

      const saveAiRules = async () => {
        try {
          await setDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'classes', currentClass), { 
            rulesText: aiRulesText, rulesPdfName: pdfFile.name, rulesPdfBase64: pdfFile.base64, rulesFileMimeType: pdfFile.mimeType || 'application/pdf'
          }, { merge: true });
          showToast("ä¿å­˜æˆåŠŸï¼AI å®¡æ ¸ç»†åˆ™å·²å…¨å±€ç”Ÿæ•ˆ", 'success');
        } catch (error) { showToast("è§„åˆ™ä¿å­˜å¤±è´¥", 'error'); }
      };

      const GlobalModals = () => (
        <React.Fragment>
          {toast.show && (
            <div className={`fixed top-6 right-6 z-[100] flex items-center gap-2 px-4 py-3 rounded-lg shadow-xl text-sm font-medium animate-in slide-in-from-top-4 duration-300 ${toast.type === 'error' ? 'bg-red-50 border border-red-200 text-red-700' : 'bg-green-50 border border-green-200 text-green-700'}`}>
              {toast.type === 'error' ? <AlertCircle className="w-5 h-5" /> : <CheckCircle className="w-5 h-5" />}
              <span>{toast.message}</span>
            </div>
          )}
          {previewImage && (
            <div className="fixed inset-0 z-[110] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 cursor-pointer" onClick={() => setPreviewImage(null)}>
              <img src={previewImage} className="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain" onClick={e => e.stopPropagation()} />
            </div>
          )}
          {isBatching && (
            <div className="fixed inset-0 z-[120] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
               <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center max-w-md w-full">
                  <Loader2 className="w-12 h-12 text-indigo-600 animate-spin mb-4" />
                  <h3 className="text-xl font-bold text-slate-800 mb-2">AI æµæ°´çº¿å®¡æ ¸ä¸­</h3>
                  <p className="text-slate-500 text-sm mb-6 text-center">ç³»ç»Ÿæ­£åœ¨é€ä¸€æ ¸å¯¹åŒå­¦ææ–™...</p>
                  <p className="text-sm font-medium text-indigo-700">{batchProgress}</p>
               </div>
            </div>
          )}
          {confirmDialog.show && (
            <div className="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
              <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
                <h3 className="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><AlertTriangle className="w-5 h-5 text-amber-500" /> ç¡®è®¤æ“ä½œ</h3>
                <p className="text-slate-600 text-sm mb-6">{confirmDialog.message}</p>
                <div className="flex justify-end gap-3">
                  <button onClick={() => setConfirmDialog({show:false})} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                  <button onClick={confirmDialog.onConfirm} className="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg">ç¡®å®š</button>
                </div>
              </div>
            </div>
          )}
        </React.Fragment>
      );

      if (viewState === 'lobby') {
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
            <GlobalModals />
            <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-5xl">
              <div className="flex flex-col items-center mb-8">
                <div className="p-4 bg-indigo-100 rounded-full mb-4">
                  <Trophy className="w-10 h-10 text-indigo-600" />
                </div>
                <h1 className="text-3xl font-bold text-slate-800">ç»¼åˆæµ‹è¯„ä¸å¥–å­¦é‡‘ç®¡ç†ç³»ç»Ÿ</h1>
                <p className="text-slate-500 mt-2">é€‰æ‹©æ‚¨çš„ç­çº§ä»¥å‚ä¸è¯„å®šï¼Œæˆ–åˆ›å»ºæ–°è¯„å®šé¡¹ç›®</p>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="bg-slate-50 rounded-xl p-6 border border-slate-200">
                  <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Users className="w-5 h-5 text-indigo-500" /> æ­£åœ¨è¿›è¡Œçš„è¯„å®šç­çº§</h2>
                  <div className="space-y-3 overflow-y-auto pr-2 max-h-[400px]">
                    {Object.keys(classesData).length === 0 ? (
                      <p className="text-center py-10 text-slate-400 text-sm">å¤§å…ç©ºç©ºå¦‚ä¹Ÿï¼Œæš‚æ— ç­çº§</p>
                    ) : (
                      Object.keys(classesData).map(cName => {
                        const count = studentsData.filter(s => s.className === cName).length;
                        return (
                          <button key={cName} onClick={() => initiateJoinClass(cName)} className="w-full text-left bg-white px-4 py-3 rounded-lg border border-slate-200 hover:border-indigo-400 hover:shadow-sm transition-all flex justify-between items-center group">
                            <div>
                              <span className="font-medium text-slate-700 group-hover:text-indigo-700 block">{cName}</span>
                              <span className="text-[10px] text-slate-400 flex items-center gap-1 mt-1"><Fingerprint className="w-3 h-3"/> éœ€èº«ä»½éªŒè¯</span>
                            </div>
                            <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{count} äººå·²æäº¤</span>
                          </button>
                        );
                      })
                    )}
                  </div>
                </div>
                <div className="bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                  <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><ShieldCheck className="w-5 h-5 text-indigo-500" /> åˆ›å»ºæ–°ç­çº§</h2>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">ç­çº§åç§°</label>
                      <input type="text" className="w-full px-4 py-2.5 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500" value={newClassNameInput} onChange={e => setNewClassNameInput(e.target.value)} />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">ç®¡ç†å‘˜å¯†ç </label>
                      <input type="password" placeholder="è®¾ç½®ç®¡ç†å‘˜å¯†ç  (å¿…å¡«)" className="w-full px-4 py-2.5 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500" value={newClassAdminPwdInput} onChange={e => setNewClassAdminPwdInput(e.target.value)} />
                    </div>
                    <div className="pt-4 mt-2 border-t border-indigo-100">
                      <label className="block text-sm font-medium text-slate-700 mb-1">å¯¼å…¥ç­çº§åå• (æ”¯æŒ Excel/å›¾ç‰‡/CSV)</label>
                      <label className={`cursor-pointer flex items-center justify-center w-full py-2.5 bg-white border border-dashed border-indigo-300 rounded-lg hover:bg-indigo-50 text-indigo-700 text-sm font-medium ${isAiParsingRoster ? 'opacity-50 pointer-events-none' : ''}`}>
                        {isAiParsingRoster ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : <UploadCloud className="w-4 h-4 mr-2" />} 
                        {isAiParsingRoster ? 'AI æ­£åœ¨æå–ä¸­...' : 'é€‰æ‹©è¡¨æ ¼/å›¾ç‰‡è®© AI æå–'}
                        <input type="file" accept=".csv, .txt, .xlsx, .xls, image/*" className="hidden" onChange={handleRosterUpload} disabled={isAiParsingRoster} />
                      </label>
                      {newClassRoster.length > 0 && !isAiParsingRoster && (
                         <div className="mt-2 text-xs text-green-600 bg-green-50 px-3 py-1.5 rounded-md flex items-center gap-1"><CheckCircle className="w-3.5 h-3.5"/> å·²é”å®š {newClassRoster.length} åå­¦ç”Ÿåå•</div>
                      )}
                    </div>
                    <button onClick={handleCreateClass} disabled={isAiParsingRoster} className={`w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition-colors mt-2 ${isAiParsingRoster ? 'opacity-50 cursor-not-allowed' : ''}`}>ç¡®è®¤åˆ›å»ºç­çº§</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (viewState === 'login') {
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
            <GlobalModals />
            <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
              <button onClick={() => setViewState('lobby')} className="text-sm text-slate-500 hover:text-indigo-600 mb-6 flex items-center gap-1">&larr; è¿”å›å¤§å…</button>
              <h2 className="text-2xl font-bold text-slate-800 mb-6">åŠ å…¥ {selectedClassToJoin}</h2>
              <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg mb-6">
                <button onClick={() => setLoginRoleTab('student')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${loginRoleTab === 'student' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-800'}`}>èº«ä»½åŒ¹é… (å­¦ç”Ÿ)</button>
                <button onClick={() => setLoginRoleTab('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-colors ${loginRoleTab === 'admin' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-800'}`}>å¯†ç è¿›å…¥ (ç®¡ç†å‘˜)</button>
              </div>
              <div className="space-y-4">
                {loginRoleTab === 'student' ? (
                  <React.Fragment>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">çœŸå®å§“å</label><input type="text" className="w-full px-4 py-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500" value={userNameInput} onChange={e => setUserNameInput(e.target.value)} /></div>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">å­¦å·</label><input type="text" className="w-full px-4 py-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500" value={studentIdInput} onChange={e => setStudentIdInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} /></div>
                  </React.Fragment>
                ) : (
                  <div><label className="block text-sm font-medium text-slate-700 mb-1">ç®¡ç†å‘˜å¯†ç </label><input type="password" placeholder="è¯·è¾“å…¥ç³»ç»Ÿç®¡ç†å¯†ç " className="w-full px-4 py-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500" value={adminPwdInput} onChange={e => setAdminPwdInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} /></div>
                )}
                <button onClick={handleLogin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition-colors mt-4">éªŒè¯èº«ä»½å¹¶è¿›å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen flex flex-col bg-slate-50">
          <GlobalModals />
          <header className="bg-white border-b border-slate-200 sticky top-0 z-40 h-16">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Trophy className="w-6 h-6 text-indigo-600" />
                <h1 className="text-xl font-bold text-slate-800">{currentClass} <span className="text-sm font-normal text-slate-500 ml-2">ç»¼æµ‹è¯„å®š</span></h1>
              </div>
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100">
                  <div className={`w-2 h-2 rounded-full ${currentUserRole === 'admin' ? 'bg-amber-500' : 'bg-green-500'}`}></div>
                  <span className="text-sm font-medium text-slate-700">{currentUser}</span>
                </div>
                {currentUserRole === 'admin' && <button onClick={handleDeleteClassByAdmin} className="text-sm text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-md flex items-center gap-1"><Trash2 className="w-4 h-4"/> åˆ é™¤ç­çº§</button>}
                <button onClick={handleLeaveClass} className="text-sm text-slate-500 hover:text-slate-800 flex items-center gap-1"><LogOut className="w-4 h-4" /> é€€å‡º</button>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full mt-6">
            <div className="flex space-x-1 bg-slate-200/50 p-1 rounded-xl">
              <button onClick={() => setActiveTab('ranking')} className={`flex-1 py-2.5 text-sm font-medium rounded-lg flex items-center justify-center gap-2 ${activeTab === 'ranking' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-200/50'}`}><Trophy className="w-4 h-4" /> å®æ—¶æ’åæ¦œ</button>
              {currentUserRole === 'student' && <button onClick={initMyApplication} className={`flex-1 py-2.5 text-sm font-medium rounded-lg flex items-center justify-center gap-2 ${activeTab === 'application' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-200/50'}`}><Edit3 className="w-4 h-4" /> {isReadOnly ? 'æŸ¥çœ‹ä»–äººè¯¦æƒ…' : 'æˆ‘çš„ç”³æŠ¥'}</button>}
              {currentUserRole === 'admin' && isReadOnly && <button className="flex-1 py-2.5 text-sm font-medium rounded-lg bg-white text-amber-700 shadow-sm flex items-center justify-center gap-2"><Eye className="w-4 h-4" /> æ­£åœ¨å®¡é˜…: {formName}</button>}
              <button onClick={() => setActiveTab('ai-rules')} className={`flex-1 py-2.5 text-sm font-medium rounded-lg flex items-center justify-center gap-2 ${activeTab === 'ai-rules' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-200/50'}`}><Sparkles className="w-4 h-4" /> AIå®¡æ ¸è§„åˆ™é…ç½®</button>
            </div>
          </div>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full flex-1 py-8">
            {activeTab === 'ranking' && (
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                {currentUserRole === 'admin' && (
                  <div className="bg-indigo-50 p-4 border-b border-indigo-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div className="flex items-center gap-2 text-indigo-800 text-sm font-medium">
                      <Sparkles className="w-5 h-5 text-indigo-600" />
                      å…¨ç­å…±æœ‰ <strong className="text-lg text-indigo-600">{currentStudents.filter(s=>s.bonusItems?.some(i=>i.aiStatus==='Pending'||!i.aiStatus)).length}</strong> ååŒå­¦çš„ææ–™å¾… AI å®¡æ ¸
                    </div>
                    <button onClick={handleBatchAudit} className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2"><PlayCircle className="w-4 h-4" /> ä¸€é”®æ‰¹é‡æ™ºèƒ½å®¡æ ¸</button>
                  </div>
                )}
                <div className="p-6 border-b border-slate-200 bg-slate-50/50 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                  <div>
                    <h2 className="text-lg font-bold text-slate-800">å®æ—¶æ’åæ¦œ</h2>
                    <p className="text-sm text-slate-500 mt-1">æ’ååŠåˆ†æ•°åŸºäºå…¨ç­æœ€é«˜åŠ åˆ†è‡ªåŠ¨æŠ˜ç®—åŒæ­¥ã€‚</p>
                  </div>
                  <div className="flex gap-3">
                    <button onClick={exportTable} className="flex items-center gap-1.5 px-4 py-2 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg text-sm font-medium border border-green-200"><ListOrdered className="w-4 h-4" /> å¯¼å‡ºè¯¦ç»†æ˜ç»†è¡¨ (Excel)</button>
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left border-collapse min-w-[900px]">
                    <thead>
                      <tr className="bg-slate-100 text-slate-600 text-sm">
                        <th className="px-6 py-4 font-semibold w-20 text-center">æ’å</th><th className="px-6 py-4 font-semibold">å§“å / å­¦å·</th><th className="px-6 py-4 font-semibold">åŸå§‹æˆç»©</th><th className="px-6 py-4 font-semibold text-slate-400">ç”³æŠ¥åŠ åˆ†æ€»è®¡</th><th className="px-6 py-4 font-semibold text-indigo-600">æŠ˜ç®—åŠ åˆ†(Max3)</th><th className="px-6 py-4 font-semibold text-lg text-slate-800">æ€»åˆ†</th><th className="px-6 py-4 font-semibold">çŠ¶æ€</th><th className="px-6 py-4 font-semibold text-center">æ˜ç»†</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {rankedStudents.length === 0 ? (
                        <tr><td colSpan="8" className="px-6 py-12 text-center text-slate-500">å½“å‰ç­çº§è¿˜æ²¡æœ‰äººå½•å…¥æ•°æ®ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹ã€‚</td></tr>
                      ) : (
                        rankedStudents.map((s, idx) => (
                          <tr key={s.id} className={`${s.studentId === currentStudentId ? 'bg-indigo-50/50' : 'hover:bg-slate-50'} transition-colors`}>
                            <td className="px-6 py-4">
                              <div className={`mx-auto w-8 h-8 flex items-center justify-center rounded-full font-bold ${idx === 0 ? 'bg-yellow-100 text-yellow-700' : idx === 1 ? 'bg-slate-200 text-slate-700' : idx === 2 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>{idx+1}</div>
                            </td>
                            <td className="px-6 py-4">
                              <div className="font-medium text-slate-800 flex items-center gap-2">{s.name} {s.studentId === currentStudentId && <span className="text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded-full">æˆ‘</span>}</div>
                              <div className="text-xs text-slate-400 mt-0.5">{s.studentId}</div>
                            </td>
                            <td className="px-6 py-4 text-slate-600">{s.originalGrade}</td>
                            <td className="px-6 py-4 text-slate-400">{s.rawBonus}</td>
                            <td className="px-6 py-4 font-medium text-indigo-600">+{s.scaledBonus}</td>
                            <td className="px-6 py-4 font-bold text-lg text-slate-800">{s.totalScore}</td>
                            <td className="px-6 py-4">{s.hasAiWarning ? <div className="text-red-600 bg-red-50 text-xs font-medium px-2 py-1 rounded w-max flex items-center gap-1" title="å­˜åœ¨å¼‚å¸¸æˆ–é©³å›çš„é¡¹"><AlertTriangle className="w-3.5 h-3.5"/> çŠ¶æ€å¼‚å¸¸</div> : <div className="text-green-600 text-xs font-medium flex items-center gap-1 w-max"><CheckCircle className="w-3.5 h-3.5"/> æ­£å¸¸</div>}</td>
                            <td className="px-6 py-4 text-center"><button onClick={()=>loadStudentFormReadOnly(s)} className="text-indigo-600 bg-indigo-50 hover:bg-indigo-100 text-sm font-medium px-3 py-1.5 rounded-md transition-colors flex items-center justify-center gap-1 mx-auto">{s.studentId === currentStudentId && currentUserRole === 'student' ? <><Edit3 className="w-3.5 h-3.5"/>ç¼–è¾‘</> : <><Eye className="w-3.5 h-3.5"/>æŸ¥çœ‹</>}</button></td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {activeTab === 'application' && (
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 relative">
                {isReadOnly && <div className="absolute top-0 left-0 w-full bg-amber-50 text-amber-800 text-sm py-2 px-6 font-medium flex items-center gap-2 border-b border-amber-200 rounded-t-2xl"><Eye className="w-4 h-4" /> {currentUserRole === 'admin' ? `ç®¡ç†å‘˜å®¡é˜…æ¨¡å¼ï¼šæ­£åœ¨æŸ¥çœ‹ ${formName} çš„ç”³æŠ¥æ˜ç»†ã€‚` : `æ‚¨æ­£åœ¨æŸ¥çœ‹ ${formName} çš„æ˜ç»†ã€‚å› æƒé™æ— æ³•ä¿®æ”¹ã€‚`}</div>}
                <div className={`mb-6 ${isReadOnly ? 'mt-8' : ''}`}>
                  <h2 className="text-lg font-bold text-slate-800">{isReadOnly ? `${formName} çš„ç”³æŠ¥è¯¦æƒ…` : 'æˆ‘çš„æˆç»©ä¸åŠ åˆ†å½•å…¥'}</h2>
                  {!isReadOnly && <p className="text-sm text-slate-500 mt-1">æ‰€æœ‰æ•°æ®æé€Ÿä¿å­˜ï¼ŒAI æ™ºèƒ½å®¡æ ¸å°†ç”±ç®¡ç†å‘˜ç»Ÿä¸€æ‰§è¡Œã€‚</p>}
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  <div><label className="block text-sm font-medium text-slate-700 mb-1">å§“å (è‡ªåŠ¨é”å®š)</label><input type="text" value={formName} disabled className="w-full px-4 py-2.5 rounded-lg border border-slate-200 bg-slate-50 text-slate-500 outline-none" /></div>
                  <div><label className="block text-sm font-medium text-slate-700 mb-1">åŸå§‹æˆç»© {isReadOnly ? '' : '(å¿…å¡«)'}</label><input type="number" value={formOriginalGrade} onChange={e=>setFormOriginalGrade(e.target.value)} disabled={isReadOnly} placeholder="ä¾‹å¦‚ï¼š90" className={`w-full px-4 py-2.5 rounded-lg border ${isReadOnly ? 'border-slate-200 bg-slate-50' : 'border-slate-300 focus:ring-2 focus:ring-indigo-500 bg-white'} outline-none`} /></div>
                </div>
                <div className="mb-4 flex items-center justify-between border-b border-slate-100 pb-4"><h3 className="text-md font-semibold text-slate-800 flex items-center gap-2"><BookOpen className="w-5 h-5 text-indigo-500" /> ç»¼æµ‹åŠ åˆ†æ˜ç»†</h3>{!isReadOnly && <button onClick={()=>{setFormBonusItems([...formBonusItems, {id: Date.now(), points:'', type:'', description:'', aiStatus: 'Pending'}])}} className="flex items-center gap-2 px-4 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium transition-colors"><PlusCircle className="w-4 h-4" /> æ·»åŠ åŠ åˆ†é¡¹</button>}</div>
                <div className="space-y-4">
                  {formBonusItems.length === 0 ? (
                    <div className="text-center py-10 bg-slate-50 rounded-xl border border-dashed border-slate-300"><p className="text-slate-500">{isReadOnly ? 'è¯¥åŒå­¦æš‚æœªç”³æŠ¥åŠ åˆ†' : 'æš‚æ— åŠ åˆ†é¡¹ç›®ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ '}</p></div>
                  ) : (
                    formBonusItems.map(item => (
                      <div key={item.id} className={`p-4 rounded-xl border relative group ${isReadOnly ? 'bg-slate-50/50 border-slate-200' : 'bg-white border-slate-200 shadow-sm'}`}>
                        {!isReadOnly && <button onClick={()=>setFormBonusItems(formBonusItems.filter(i=>i.id!==item.id))} className="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors"><Trash2 className="w-5 h-5" /></button>}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3 pr-8">
                          <div><label className="block text-xs text-slate-500 mb-1">ç”³è¯·åˆ†æ•°</label><input type="number" step="0.01" value={item.points} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, points: e.target.value}:i))} disabled={isReadOnly} className={`w-full px-3 py-2 rounded border text-sm outline-none ${isReadOnly?'bg-transparent border-transparent px-0 font-medium text-slate-800':'border-slate-300 focus:ring-1 focus:ring-indigo-500'}`} /></div>
                          <div><label className="block text-xs text-slate-500 mb-1">æ´»åŠ¨ç±»å‹</label><input type="text" value={item.type} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, type: e.target.value}:i))} disabled={isReadOnly} className={`w-full px-3 py-2 rounded border text-sm outline-none ${isReadOnly?'bg-transparent border-transparent px-0 font-medium text-slate-800':'border-slate-300 focus:ring-1 focus:ring-indigo-500'}`} /></div>
                          <div className="md:col-span-2"><label className="block text-xs text-slate-500 mb-1">æ´»åŠ¨è¯´æ˜</label><input type="text" value={item.description} onChange={e=>setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, description: e.target.value}:i))} disabled={isReadOnly} className={`w-full px-3 py-2 rounded border text-sm outline-none ${isReadOnly?'bg-transparent border-transparent px-0 font-medium text-slate-800':'border-slate-300 focus:ring-1 focus:ring-indigo-500'}`} /></div>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center pt-4 border-t border-slate-100">
                          <div className="flex-1 flex items-center gap-2">
                            {!isReadOnly && <label className="cursor-pointer px-3 py-1.5 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors flex items-center gap-2 text-sm text-slate-700"><UploadCloud className="w-4 h-4" />ä¸Šä¼ ææ–™<input type="file" accept="image/*" className="hidden" onChange={e=>{const f=e.target.files[0];if(f){compressImage(f, b64=>{setFormBonusItems(formBonusItems.map(i=>i.id===item.id?{...i, materialName: f.name, materialBase64: b64, aiStatus: 'Pending'}:i));});}}} /></label>}
                            {item.materialName ? <button onClick={()=>item.materialBase64 && setPreviewImage(item.materialBase64)} className="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded max-w-[200px] truncate flex items-center gap-1 hover:bg-indigo-100 transition-colors"><FileText className="w-3 h-3 flex-shrink-0"/>{item.materialName}</button> : <span className="text-xs text-slate-400">æ— ææ–™</span>}
                          </div>
                          {item.aiStatus && item.aiStatus !== 'Pending' && <div className={`text-xs font-medium px-3 py-1.5 rounded-md border flex items-center gap-2 ${item.aiStatus==='Approve'?'bg-green-50 text-green-700 border-green-200':'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>{item.aiStatus==='Approve'?<CheckCircle className="w-3.5 h-3.5"/>:<Clock className="w-3.5 h-3.5"/>}<span>{item.aiStatus==='Approve'?'AIé€šè¿‡':'éœ€äººå·¥å®¡æ ¸'}</span><span className="border-l border-current pl-2 ml-1 opacity-80 max-w-[150px] truncate" title={item.aiReason}>{item.aiReason}</span></div>}
                        </div>
                      </div>
                    ))
                  )}
                </div>
                {!isReadOnly && <div className="mt-8 flex justify-end pt-6 border-t border-slate-100"><button onClick={handleSaveStudent} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-medium shadow-sm transition-colors"><Save className="w-5 h-5" /> ä¿å­˜æˆ‘çš„ç”³æŠ¥æ•°æ®</button></div>}
              </div>
            )}

            {activeTab === 'ai-rules' && (
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 max-w-3xl mx-auto">
                <div className="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div className="p-2 bg-purple-100 rounded-lg"><Sparkles className="w-6 h-6 text-purple-600" /></div><div><h2 className="text-lg font-bold text-slate-800">ç­çº§ AI æ™ºèƒ½å®¡æ ¸é…ç½®</h2><p className="text-sm text-slate-500 mt-1">æœ¬ç­çš„æ‰€æœ‰åŒå­¦éƒ½å¯ä»¥å¯¹ AI å®¡æ ¸è§„åˆ™è¿›è¡Œè¡¥å……ã€‚</p></div></div>
                <div className="mb-8">
                  <label className="block text-sm font-medium text-slate-700 mb-2">å®˜æ–¹è¯„åˆ†æ–‡ä»¶ (æ”¯æŒ PDF/å›¾ç‰‡)</label>
                  <div className="flex flex-col sm:flex-row sm:items-center gap-4">
                    {currentUserRole === 'admin' && (
                      <button onClick={() => fileInputRef.current?.click()} className="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                        <UploadCloud className="w-4 h-4 text-slate-500" /> é€‰æ‹©/æ›¿æ¢è§„åˆ™æ–‡ä»¶
                      </button>
                    )}
                    <input type="file" accept="application/pdf, image/*" ref={fileInputRef} onChange={handleRuleFileUpload} className="hidden" />
                    {pdfFile.name ? (
                      <div className="flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded text-sm w-max">
                        <FileText className="w-4 h-4" /> 
                        <span className="font-medium truncate max-w-[200px]">{pdfFile.name}</span>
                        <span className="text-xs bg-green-200 px-1.5 rounded ml-2">å·²å°±ç»ª</span>
                      </div>
                    ) : (<span className="text-sm text-slate-400">å½“å‰æœªä¸Šä¼ ä»»ä½•æ–‡ä»¶ã€‚</span>)}
                  </div>
                </div>
                <div className="mb-6"><label className="block text-sm font-medium text-slate-700 mb-2">æ–‡å­—è¡¥å……è¯´æ˜ (æ‰€æœ‰äººå¯ç¼–è¾‘)</label><textarea rows="8" value={aiRulesText} onChange={e=>setAiRulesText(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-purple-500 bg-white text-sm leading-relaxed outline-none" placeholder="åœ¨æ­¤è¾“å…¥æˆ–è¡¥å……è¯¦ç»†åŠ åˆ†è§„åˆ™..."></textarea></div>
                <div className="flex justify-end pt-4 border-t border-slate-100"><button onClick={saveAiRules} className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors"><Save className="w-4 h-4" /> ä¿å­˜ / è¡¥å……å…¨å±€è§„åˆ™</button></div>
              </div>
            )}
          </main>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    if (!isConfigValid) {
      root.render(<ConfigErrorUI />);
    } else {
      root.render(<App />);
    }
  </script>
</body>
</html>
